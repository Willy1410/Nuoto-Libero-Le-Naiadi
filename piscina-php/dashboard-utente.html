<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Utente - Gli Squaletti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #00a8e8;
            --primary-dark: #0077b6;
            --bg: #f3f6f9;
            --text: #1f2937;
            --muted: #64748b;
            --white: #ffffff;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .header h1 { font-size: 24px; }
        .header small { opacity: 0.92; }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-logout { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-primary { background: var(--primary-dark); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-warning { background: var(--warning); color: #fff; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            padding: 16px;
            text-align: center;
        }

        .stat h2 { color: var(--primary-dark); font-size: 32px; margin-bottom: 6px; }
        .stat p { color: var(--muted); font-size: 13px; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
            padding: 16px;
            margin-bottom: 16px;
        }

        .card h3 { margin-bottom: 12px; color: #0f172a; }

        .qr-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .qr-box {
            width: 220px;
            min-height: 220px;
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .muted { color: var(--muted); font-size: 14px; }
        .small { font-size: 12px; color: var(--muted); }

        .package-list { display: grid; gap: 10px; }
        .package-item {
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .package-meta strong { display: block; margin-bottom: 4px; }
        .package-meta p { font-size: 13px; color: var(--muted); }

        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #e5e7eb; padding: 10px 8px; text-align: left; font-size: 13px; }
        th { background: #f8fafc; }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .alert {
            display: none;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .alert.ok { display: block; background: #dcfce7; color: #166534; }
        .alert.err { display: block; background: #fee2e2; color: #991b1b; }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999;
        }

        .overlay.open { display: flex; }

        .modal {
            width: 100%;
            max-width: 560px;
            background: #fff;
            border-radius: 12px;
            padding: 18px;
        }

        .modal h4 { margin-bottom: 10px; }
        .modal .row { margin-bottom: 10px; }
        .modal label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .modal textarea,
        .modal input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .payment-option {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
            .payment-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Dashboard Utente</h1>
            <small id="userName"></small>
        </div>
        <button class="btn btn-logout" onclick="logout()">Esci</button>
    </div>

    <div class="container">
        <div id="alertBox" class="alert"></div>

        <div class="stats">
            <div class="stat">
                <h2 id="statIngressi">0</h2>
                <p>Ingressi rimanenti</p>
            </div>
            <div class="stat">
                <h2 id="statCheckin">0</h2>
                <p>Check-in totali</p>
            </div>
            <div class="stat">
                <h2 id="statScadenza">-</h2>
                <p>Giorni a scadenza</p>
            </div>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h3>Il tuo QR code</h3>
                    <div id="qrSection" class="muted">Nessun QR disponibile. Acquista un pacchetto confermato.</div>
                </div>

                <div class="card">
                    <h3>Acquista pacchetto</h3>
                    <div id="packageList" class="package-list">Caricamento pacchetti...</div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>I miei acquisti</h3>
                    <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pacchetto</th>
                                    <th>Data</th>
                                    <th>Stato</th>
                                    <th>Ingressi</th>
                                    <th>Azione</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>Storico check-in</h3>
                    <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Ora</th>
                                    <th>Fascia</th>
                                    <th>Pacchetto</th>
                                    <th>Bagnino</th>
                                </tr>
                            </thead>
                            <tbody id="checkinBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Documenti</h3>
            <p class="muted">Documenti obbligatori mancanti: <strong id="missingDocs">0</strong></p>
            <div id="docList"></div>
        </div>
    </div>

    <div id="purchaseOverlay" class="overlay">
        <div class="modal">
            <h4 id="purchaseTitle">Conferma acquisto</h4>
            <p class="small" id="purchaseMeta"></p>

            <div class="row">
                <label>Metodo pagamento</label>
                <div class="payment-options">
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="carta" checked> Carta</label>
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="paypal"> PayPal</label>
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="bonifico"> Bonifico</label>
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="contanti"> In struttura</label>
                </div>
            </div>

            <div class="row">
                <label for="paymentReference">Riferimento pagamento (consigliato)</label>
                <input id="paymentReference" type="text" placeholder="ID transazione, CRO, note pagamento...">
            </div>

            <div class="row">
                <label for="paymentNote">Note</label>
                <textarea id="paymentNote" placeholder="Note aggiuntive (facoltative)"></textarea>
            </div>

            <p class="small" id="paymentHint"></p>

            <div class="modal-actions">
                <button class="btn" type="button" onclick="closePurchaseModal()">Annulla</button>
                <button class="btn btn-success" id="confirmPurchaseBtn" type="button" onclick="confirmPurchase()">Conferma acquisto</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '../api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || 'null');

        let selectedPackage = null;
        let myPurchases = [];

        if (!token || !user) {
            window.location.href = '../login.html';
        }

        document.getElementById('userName').textContent = `${user.nome} ${user.cognome}`;

        function showAlert(message, type = 'ok') {
            const box = document.getElementById('alertBox');
            box.className = `alert ${type === 'error' ? 'err' : 'ok'}`;
            box.textContent = message;
            if (type !== 'error') {
                setTimeout(() => {
                    box.className = 'alert';
                    box.textContent = '';
                }, 4500);
            }
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });
            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Errore richiesta API');
            }
            return data;
        }

        function formatDate(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return d.toLocaleDateString('it-IT');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return `${d.toLocaleDateString('it-IT')} ${d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(Number(value || 0));
        }

        function getStatusBadge(status) {
            if (status === 'confirmed') {
                return '<span class="badge badge-success">confermato</span>';
            }
            if (status === 'pending') {
                return '<span class="badge badge-warning">pending</span>';
            }
            return '<span class="badge badge-danger">annullato</span>';
        }

        function getLatestConfirmedPurchase() {
            const confirmed = myPurchases
                .filter(item => item.stato_pagamento === 'confirmed' && item.qr_code)
                .sort((a, b) => new Date(b.data_conferma || b.data_acquisto) - new Date(a.data_conferma || a.data_acquisto));
            return confirmed[0] || null;
        }

        function renderQrSection(purchase) {
            const section = document.getElementById('qrSection');
            if (!purchase) {
                section.innerHTML = '<p class="muted">Nessun QR disponibile. I pagamenti pending vengono attivati da segreteria.</p>';
                document.getElementById('statScadenza').textContent = '-';
                return;
            }

            const daysToExpire = purchase.data_scadenza
                ? Math.max(0, Math.ceil((new Date(purchase.data_scadenza) - new Date()) / 86400000))
                : '-';
            document.getElementById('statScadenza').textContent = daysToExpire;

            section.innerHTML = `
                <div class="qr-wrap">
                    <div class="qr-box" id="qrBox"></div>
                    <div>
                        <p><strong>Codice:</strong> <code>${purchase.qr_code}</code></p>
                        <p><strong>Pacchetto:</strong> ${purchase.pacchetto_nome}</p>
                        <p><strong>Scadenza:</strong> ${formatDate(purchase.data_scadenza)}</p>
                        <p><strong>Ingressi rimanenti:</strong> ${purchase.ingressi_rimanenti}</p>
                        <p style="margin-top:10px;">
                            <a class="btn btn-primary" href="../api/qr.php?action=download&acquisto_id=${encodeURIComponent(purchase.id)}">Scarica PDF QR</a>
                        </p>
                    </div>
                </div>
            `;

            const qrTarget = document.getElementById('qrBox');
            if (window.QRCode && qrTarget) {
                qrTarget.innerHTML = '';
                new QRCode(qrTarget, {
                    text: purchase.qr_code,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            }
        }

        async function loadPackages() {
            const data = await fetchJson(`${API_URL}/pacchetti.php`, { method: 'GET' });
            const list = document.getElementById('packageList');

            if (!Array.isArray(data.pacchetti) || !data.pacchetti.length) {
                list.innerHTML = '<p class="muted">Nessun pacchetto disponibile.</p>';
                return;
            }

            list.innerHTML = data.pacchetti.map(pkg => `
                <div class="package-item">
                    <div class="package-meta">
                        <strong>${pkg.nome}</strong>
                        <p>${pkg.descrizione || 'Pacchetto nuoto libero'}</p>
                        <p>${pkg.num_ingressi} ingressi - validita ${pkg.validita_giorni} giorni</p>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:700; margin-bottom:8px;">${formatCurrency(pkg.prezzo)}</div>
                        <button
                            class="btn btn-success js-buy-btn"
                            data-id="${pkg.id}"
                            data-name="${encodeURIComponent(pkg.nome)}"
                            data-price="${Number(pkg.prezzo)}"
                        >Acquista</button>
                    </div>
                </div>
            `).join('');

            list.querySelectorAll('.js-buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    openPurchaseModal(
                        Number(button.dataset.id),
                        decodeURIComponent(button.dataset.name || ''),
                        Number(button.dataset.price || 0)
                    );
                });
            });
        }

        async function loadPurchases() {
            const data = await fetchJson(`${API_URL}/pacchetti.php?action=my-purchases`, { method: 'GET' });
            myPurchases = Array.isArray(data.acquisti) ? data.acquisti : [];

            const body = document.getElementById('purchasesBody');
            if (!myPurchases.length) {
                body.innerHTML = '<tr><td colspan="5">Nessun acquisto registrato.</td></tr>';
                renderQrSection(null);
                document.getElementById('statIngressi').textContent = '0';
                return;
            }

            body.innerHTML = myPurchases.map(item => {
                const downloadAction = item.stato_pagamento === 'confirmed' && item.qr_code
                    ? `<a href="../api/qr.php?action=download&acquisto_id=${encodeURIComponent(item.id)}">PDF QR</a>`
                    : '-';

                return `
                    <tr>
                        <td>${item.pacchetto_nome}</td>
                        <td>${formatDate(item.data_acquisto)}</td>
                        <td>${getStatusBadge(item.stato_pagamento)}</td>
                        <td>${item.ingressi_rimanenti} / ${item.num_ingressi || '-'}</td>
                        <td>${downloadAction}</td>
                    </tr>
                `;
            }).join('');

            const totalRemaining = myPurchases
                .filter(item => item.stato_pagamento === 'confirmed')
                .reduce((sum, item) => sum + Number(item.ingressi_rimanenti || 0), 0);

            document.getElementById('statIngressi').textContent = String(totalRemaining);
            renderQrSection(getLatestConfirmedPurchase());
        }

        async function loadCheckins() {
            const data = await fetchJson(`${API_URL}/checkin.php?action=history`, { method: 'GET' });
            const rows = Array.isArray(data.checkins) ? data.checkins : [];
            document.getElementById('statCheckin').textContent = String(rows.length);

            const body = document.getElementById('checkinBody');
            if (!rows.length) {
                body.innerHTML = '<tr><td colspan="4">Nessun check-in registrato.</td></tr>';
                return;
            }

            body.innerHTML = rows.slice(0, 15).map(row => `
                <tr>
                    <td>${formatDateTime(row.timestamp)}</td>
                    <td>${row.fascia_oraria || '-'}</td>
                    <td>${row.pacchetto_nome || '-'}</td>
                    <td>${row.bagnino_nome || '-'} ${row.bagnino_cognome || ''}</td>
                </tr>
            `).join('');
        }

        async function loadDocuments() {
            const data = await fetchJson(`${API_URL}/documenti.php`, { method: 'GET' });
            const rows = Array.isArray(data.documenti) ? data.documenti : [];
            document.getElementById('missingDocs').textContent = String(data.documenti_obbligatori_mancanti || 0);

            const list = document.getElementById('docList');
            if (!rows.length) {
                list.innerHTML = '<p class="muted">Nessun documento caricato.</p>';
                return;
            }

            list.innerHTML = rows.map(row => {
                const statusClass = row.stato === 'approved' ? 'badge-success' : (row.stato === 'pending' ? 'badge-warning' : 'badge-danger');
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin-top:8px;">
                        <div>
                            <strong>${row.tipo_nome}</strong>
                            <div class="small">Caricato: ${formatDate(row.data_caricamento)}</div>
                        </div>
                        <span class="badge ${statusClass}">${row.stato}</span>
                    </div>
                `;
            }).join('');
        }

        function openPurchaseModal(id, name, price) {
            selectedPackage = { id, name, price };
            document.getElementById('purchaseTitle').textContent = `Acquisto: ${name}`;
            document.getElementById('purchaseMeta').textContent = `Importo: ${formatCurrency(price)} - Conferma metodo di pagamento.`;
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNote').value = '';
            document.querySelector('input[name="paymentMethod"][value="carta"]').checked = true;
            updatePaymentHint();
            document.getElementById('purchaseOverlay').classList.add('open');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseOverlay').classList.remove('open');
            selectedPackage = null;
        }

        function updatePaymentHint() {
            const method = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'carta';
            const hint = document.getElementById('paymentHint');

            if (method === 'carta' || method === 'paypal') {
                hint.textContent = 'Pagamento online (test locale): il pacchetto viene confermato subito e il QR viene generato immediatamente.';
                return;
            }

            hint.textContent = 'Metodo offline: l\'acquisto resta pending finche segreteria non conferma il pagamento.';
        }

        async function confirmPurchase() {
            if (!selectedPackage) return;

            const method = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'carta';
            const reference = document.getElementById('paymentReference').value.trim();
            const note = document.getElementById('paymentNote').value.trim();
            const button = document.getElementById('confirmPurchaseBtn');

            if (method === 'bonifico' && reference.length < 3) {
                showAlert('Inserisci un riferimento bonifico valido.', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'Elaborazione...';

            try {
                const payload = {
                    pacchetto_id: selectedPackage.id,
                    metodo_pagamento: method,
                    riferimento_pagamento: reference,
                    note_pagamento: note
                };

                const data = await fetchJson(`${API_URL}/pacchetti.php`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                showAlert(data.message || 'Acquisto completato.', 'ok');
                closePurchaseModal();
                await loadPurchases();
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Conferma acquisto';
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
            input.addEventListener('change', updatePaymentHint);
        });

        document.getElementById('purchaseOverlay').addEventListener('click', (event) => {
            if (event.target.id === 'purchaseOverlay') {
                closePurchaseModal();
            }
        });

        Promise.all([loadPackages(), loadPurchases(), loadCheckins(), loadDocuments()])
            .catch(error => showAlert(error.message, 'error'));

        window.openPurchaseModal = openPurchaseModal;
        window.closePurchaseModal = closePurchaseModal;
        window.confirmPurchase = confirmPurchase;
        window.logout = logout;
    </script>
</body>
</html>
