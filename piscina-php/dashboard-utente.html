<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Utente</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#f3f4f6;color:#111827}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:28px}.container{max-width:1200px;margin:20px auto;padding:0 14px}
.btn{border:none;border-radius:8px;padding:8px 11px;font-weight:600;cursor:pointer;color:#fff;font-size:12px}.btn-danger{background:#dc2626}.btn-primary{background:#667eea}.btn-success{background:#059669}.btn-muted{background:#6b7280}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:14px}.stat{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:10px;padding:12px;text-align:center}.stat b{font-size:26px}
.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:14px}
.table-wrap{overflow:auto}.t{width:100%;border-collapse:collapse;min-width:650px}.t th{background:#f9fafb;font-size:12px;text-align:left;padding:8px;border-bottom:1px solid #e5e7eb}.t td{padding:8px;border-bottom:1px solid #f0f0f0;font-size:13px;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}.ok{background:#d1fae5;color:#065f46}.warn{background:#fef3c7;color:#92400e}.err{background:#fee2e2;color:#991b1b}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}.tools input,.tools select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
.alert{padding:10px 12px;border-radius:8px;margin-bottom:10px;font-weight:600}.alert.success{background:#d1fae5;color:#065f46}.alert.error{background:#fee2e2;color:#991b1b}
#qrCanvas{display:block;margin:10px auto;background:#fff;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
<div class="header"><div><h1>Dashboard Utente</h1><small id="uname"></small></div><button class="btn btn-danger" onclick="logout()">Esci</button></div>
<div class="container">
<div id="alerts"></div>
<div class="stats"><div class="stat"><b id="s_entries">-</b><div>Ingressi rimanenti</div></div><div class="stat"><b id="s_checkins">-</b><div>Check-in totali</div></div><div class="stat"><b id="s_days">-</b><div>Giorni validita</div></div></div>
<div class="card"><h3>Il tuo QR</h3><canvas id="qrCanvas" width="220" height="220"></canvas><div style="text-align:center" id="qrCodeText">Nessun QR disponibile</div><div class="tools" style="justify-content:center"><button class="btn btn-primary" onclick="openQrView()">Apri vista QR</button><button class="btn btn-muted" onclick="printQr()">Stampa QR</button></div></div>
<div class="card"><h3>Acquista pacchetto</h3><div id="pkgList"></div></div>
<div class="card"><h3>I tuoi acquisti</h3><div class="table-wrap"><table class="t"><thead><tr><th>Pacchetto</th><th>Data</th><th>Stato</th><th>Ingressi</th><th>Scadenza</th></tr></thead><tbody id="tb_purchases"></tbody></table></div></div>
<div class="card"><h3>Documenti</h3><p><strong>Mancanti:</strong> <span id="docMissing">-</span></p><div class="table-wrap"><table class="t"><thead><tr><th>Tipo</th><th>Stato</th><th>Data</th></tr></thead><tbody id="tb_docs"></tbody></table></div></div>
<div class="card"><h3>Storico check-in</h3><div class="table-wrap"><table class="t"><thead><tr><th>Data</th><th>Fascia</th><th>Pacchetto</th></tr></thead><tbody id="tb_checkins"></tbody></table></div></div>
</div>
<script>
const API='../api';const TOKEN=localStorage.getItem('token');const USER=JSON.parse(localStorage.getItem('user')||'{}');if(!TOKEN||!USER.id)location.href='../login.html';
uname.textContent=`${USER.nome||''} ${USER.cognome||''}`.trim();let lastQr='';
function alertBox(m,t='success'){alerts.innerHTML=`<div class="alert ${t}">${m}</div>`;if(t==='success')setTimeout(()=>alerts.innerHTML='',3200)}
function eur(v){return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(v||0));}
async function api(url,opt={}){const r=await fetch(url,{...opt,headers:{Authorization:`Bearer ${TOKEN}`,...(opt.headers||{})}});const tx=await r.text();let d={};try{d=JSON.parse(tx);}catch(e){throw new Error('Risposta API non valida')}if(!r.ok||d.success===false)throw new Error(d.message||`Errore ${r.status}`);return d}
function daysLeft(dateStr){if(!dateStr)return '-';const d=Math.ceil((new Date(dateStr)-new Date())/(1000*60*60*24));return d>0?d:0}
async function loadPurchases(){try{const d=await api(`${API}/pacchetti.php?action=my-purchases`);const list=d.acquisti||[];tb_purchases.innerHTML=list.map(a=>`<tr><td>${a.pacchetto_nome}</td><td>${new Date(a.data_acquisto).toLocaleDateString('it-IT')}</td><td>${a.stato_pagamento==='confirmed'?'<span class="badge ok">confirmed</span>':'<span class="badge warn">'+a.stato_pagamento+'</span>'}</td><td>${a.ingressi_rimanenti} / ${a.num_ingressi||'-'}</td><td>${a.data_scadenza||'-'}</td></tr>`).join('')||'<tr><td colspan="5">Nessun acquisto</td></tr>';
const conf=list.filter(a=>a.stato_pagamento==='confirmed');const entries=conf.reduce((s,a)=>s+Number(a.ingressi_rimanenti||0),0);s_entries.textContent=entries;const top=conf[0];if(top&&top.qr_code){lastQr=top.qr_code;qrCodeText.textContent=top.qr_code;QRCode.toCanvas(document.getElementById('qrCanvas'),top.qr_code,{width:220},()=>{});s_days.textContent=daysLeft(top.data_scadenza);}else{lastQr='';qrCodeText.textContent='Nessun QR disponibile';const ctx=qrCanvas.getContext('2d');ctx.clearRect(0,0,220,220);s_days.textContent='-';}}catch(e){alertBox(e.message,'error')}}

async function loadCheckins(){try{const d=await api(`${API}/checkin.php?action=history`);const rows=d.checkins||[];s_checkins.textContent=rows.length;tb_checkins.innerHTML=rows.map(c=>`<tr><td>${new Date(c.timestamp).toLocaleString('it-IT')}</td><td>${c.fascia_oraria}</td><td>${c.pacchetto_nome}</td></tr>`).join('')||'<tr><td colspan="3">Nessun check-in</td></tr>';}catch(e){alertBox(e.message,'error')}}

async function loadDocs(){try{const d=await api(`${API}/documenti.php`);docMissing.textContent=d.documenti_obbligatori_mancanti;tb_docs.innerHTML=(d.documenti||[]).map(x=>`<tr><td>${x.tipo_nome}</td><td>${x.stato==='approved'?'<span class="badge ok">approved</span>':x.stato==='rejected'?'<span class="badge err">rejected</span>':'<span class="badge warn">pending</span>'}</td><td>${x.data_caricamento?new Date(x.data_caricamento).toLocaleDateString('it-IT'):'-'}</td></tr>`).join('')||'<tr><td colspan="3">Nessun documento</td></tr>';}catch(e){alertBox(e.message,'error')}}

async function loadPackages(){try{const d=await fetch(`${API}/pacchetti.php`);const tx=await d.text();const j=JSON.parse(tx);if(!d.ok||!j.success)throw new Error(j.message||'Errore pacchetti');pkgList.innerHTML=(j.pacchetti||[]).map(p=>`<div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-bottom:8px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap"><div><strong>${p.nome}</strong> - ${eur(p.prezzo)}<br><small>${p.descrizione||''}</small></div><button class="btn btn-success" onclick="buyPackage(${p.id},'${p.nome.replace(/'/g,"\\'")}')">Acquista</button></div>`).join('')||'Nessun pacchetto disponibile';}catch(e){alertBox(e.message,'error')}}

async function buyPackage(id,name){if(!confirm(`Confermi acquisto: ${name}?`))return;try{const d=await api(`${API}/pacchetti.php`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pacchetto_id:id,metodo_pagamento:'bonifico'})});alertBox(d.message||'Acquisto registrato');await loadPurchases();}catch(e){alertBox(e.message,'error')}}
function openQrView(){if(!lastQr){alertBox('Nessun QR disponibile','error');return;}window.open(`../qr-view.html?qr=${encodeURIComponent(lastQr)}`,'_blank');}
function printQr(){if(!lastQr){alertBox('Nessun QR disponibile','error');return;}const data=qrCanvas.toDataURL('image/png');const w=window.open('','_blank');w.document.write(`<html><head><title>QR ${lastQr}</title></head><body style="font-family:Arial;text-align:center;padding:20px"><h2>Codice QR</h2><img src="${data}" style="width:280px;height:280px"><p><strong>${lastQr}</strong></p></body></html>`);w.document.close();w.focus();w.print();}
function logout(){localStorage.clear();location.href='../login.html'}
async function init(){try{await loadPurchases();await loadCheckins();await loadDocs();await loadPackages();}catch(e){alertBox(e.message,'error')}}init();
</script>
</body>
</html>
