<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Utente - Gli Squaletti</title>
    <style>
        :root {
            --primary: #00a8e8;
            --primary-dark: #0077b6;
            --bg: #f3f6f9;
            --text: #1f2937;
            --muted: #64748b;
            --white: #ffffff;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .header h1 { font-size: 24px; }
        .header small { opacity: 0.92; }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-logout { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-primary { background: var(--primary-dark); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-secondary { background: #475569; color: #fff; }
        .btn-light { background: #e2e8f0; color: #0f172a; }
        .btn-sm { padding: 8px 10px; font-size: 12px; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            padding: 16px;
            text-align: center;
        }

        .stat h2 { color: var(--primary-dark); font-size: 32px; margin-bottom: 6px; }
        .stat p { color: var(--muted); font-size: 13px; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
            padding: 16px;
            margin-bottom: 16px;
        }

        .card h3 { margin-bottom: 12px; color: #0f172a; }

        .qr-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .qr-box {
            width: 220px;
            min-height: 220px;
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        .qr-box img {
            max-width: 100%;
            width: 200px;
            height: 200px;
            display: block;
            object-fit: contain;
            border-radius: 8px;
            background: #fff;
        }

        .muted { color: var(--muted); font-size: 14px; }
        .small { font-size: 12px; color: var(--muted); }

        .package-list { display: grid; gap: 10px; }
        .package-item {
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .package-meta strong { display: block; margin-bottom: 4px; }
        .package-meta p { font-size: 13px; color: var(--muted); }

        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #e5e7eb; padding: 10px 8px; text-align: left; font-size: 13px; }
        th { background: #f8fafc; }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .alert {
            display: none;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .alert.ok { display: block; background: #dcfce7; color: #166534; }
        .alert.err { display: block; background: #fee2e2; color: #991b1b; }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999;
        }

        .overlay.open { display: flex; }

        .modal {
            width: 100%;
            max-width: 560px;
            background: #fff;
            border-radius: 12px;
            padding: 18px;
        }

        .modal h4 { margin-bottom: 10px; }
        .modal .row { margin-bottom: 10px; }
        .modal label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .modal textarea,
        .modal input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .payment-option {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .profile-form {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .profile-field.full {
            grid-column: 1 / -1;
        }

        .profile-field label {
            font-size: 13px;
            font-weight: 600;
        }

        .profile-field input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
        }

        .profile-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
            margin-top: 10px;
        }

        .doc-column h4 {
            margin-bottom: 8px;
            color: #0f172a;
            font-size: 15px;
        }

        .doc-list {
            display: grid;
            gap: 10px;
        }

        .doc-item {
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            padding: 10px;
            background: #fff;
        }

        .doc-item h5 {
            margin-bottom: 4px;
            font-size: 14px;
            color: #0f172a;
        }

        .doc-item p {
            margin: 0 0 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .doc-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .doc-upload {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .doc-upload input[type="file"] {
            flex: 1 1 220px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px;
            background: #fff;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
            .payment-options { grid-template-columns: 1fr; }
            .profile-form { grid-template-columns: 1fr; }
            .documents-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Dashboard Utente</h1>
            <small id="userName"></small>
        </div>
        <button class="btn btn-logout" onclick="logout()">Esci</button>
    </div>

    <div class="container">
        <div id="alertBox" class="alert"></div>

        <div class="stats">
            <div class="stat">
                <h2 id="statIngressi">0</h2>
                <p>Ingressi rimanenti</p>
            </div>
            <div class="stat">
                <h2 id="statCheckin">0</h2>
                <p>Check-in totali</p>
            </div>
            <div class="stat">
                <h2 id="statScadenza">-</h2>
                <p>Giorni a scadenza</p>
            </div>
        </div>

        <div class="card">
            <h3>I tuoi dati</h3>
            <p class="small">Aggiorna recapiti e dati anagrafici quando cambiano. I documenti precompilati useranno questi dati.</p>
            <form id="profileForm" class="profile-form">
                <div class="profile-field">
                    <label for="profileNome">Nome</label>
                    <input id="profileNome" type="text" maxlength="100" required>
                </div>
                <div class="profile-field">
                    <label for="profileCognome">Cognome</label>
                    <input id="profileCognome" type="text" maxlength="100" required>
                </div>
                <div class="profile-field">
                    <label for="profileEmail">Email</label>
                    <input id="profileEmail" type="email" maxlength="255" required>
                </div>
                <div class="profile-field">
                    <label for="profileTelefono">Telefono</label>
                    <input id="profileTelefono" type="text" maxlength="30">
                </div>
                <div class="profile-field">
                    <label for="profileDataNascita">Data di nascita</label>
                    <input id="profileDataNascita" type="date">
                </div>
                <div class="profile-field">
                    <label for="profileCodiceFiscale">Codice fiscale</label>
                    <input id="profileCodiceFiscale" type="text" maxlength="16" style="text-transform:uppercase;">
                </div>
                <div class="profile-field full">
                    <label for="profileIndirizzo">Indirizzo</label>
                    <input id="profileIndirizzo" type="text" maxlength="255">
                </div>
                <div class="profile-field">
                    <label for="profileCitta">Citta</label>
                    <input id="profileCitta" type="text" maxlength="100">
                </div>
                <div class="profile-field">
                    <label for="profileCap">CAP</label>
                    <input id="profileCap" type="text" maxlength="10">
                </div>
                <div class="profile-actions profile-field full">
                    <button id="saveProfileBtn" class="btn btn-primary" type="submit">Salva dati profilo</button>
                </div>
            </form>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h3>Il tuo QR code</h3>
                    <div id="qrSection" class="muted">Nessun QR disponibile. Acquista un pacchetto confermato.</div>
                </div>

                <div class="card">
                    <h3>Acquista pacchetto</h3>
                    <div id="packageList" class="package-list">Caricamento pacchetti...</div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>I miei acquisti</h3>
                    <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pacchetto</th>
                                    <th>Data</th>
                                    <th>Stato</th>
                                    <th>Ingressi</th>
                                    <th>Azione</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>Storico check-in</h3>
                    <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Ora</th>
                                    <th>Fascia</th>
                                    <th>Pacchetto</th>
                                    <th>Bagnino</th>
                                </tr>
                            </thead>
                            <tbody id="checkinBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Documenti</h3>
            <p class="muted">Documenti obbligatori mancanti: <strong id="missingDocs">0</strong></p>
            <div class="documents-grid">
                <div class="doc-column">
                    <h4>Documenti caricati</h4>
                    <div id="uploadedDocsList" class="doc-list"></div>
                </div>
                <div class="doc-column">
                    <h4>Documenti mancanti / da completare</h4>
                    <div id="missingDocsList" class="doc-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="purchaseOverlay" class="overlay">
        <div class="modal">
            <h4 id="purchaseTitle">Conferma richiesta pacchetto</h4>
            <p class="small" id="purchaseMeta"></p>

            <div class="row">
                <label>Modalità contributo</label>
                <div class="payment-options">
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="bonifico" checked> Bonifico</label>
                    <label class="payment-option"><input type="radio" name="paymentMethod" value="contanti"> In struttura</label>
                </div>
            </div>

            <div class="row">
                <label for="paymentReference">Riferimento pagamento (consigliato)</label>
                <input id="paymentReference" type="text" placeholder="ID transazione, CRO, note pagamento...">
            </div>

            <div class="row">
                <label for="paymentNote">Note</label>
                <textarea id="paymentNote" placeholder="Note aggiuntive (facoltative)"></textarea>
            </div>

            <p class="small" id="paymentHint"></p>

            <div class="modal-actions">
                <button class="btn" type="button" onclick="closePurchaseModal()">Annulla</button>
                <button class="btn btn-success" id="confirmPurchaseBtn" type="button" onclick="confirmPurchase()">Conferma richiesta</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '../api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || 'null');

        let selectedPackage = null;
        let myPurchases = [];
        let activeQrBlobUrl = '';

        if (!token || !user) {
            window.location.href = '../login.html';
        }

        function updateHeaderUserName() {
            const displayName = `${user?.nome || ''} ${user?.cognome || ''}`.trim();
            document.getElementById('userName').textContent = displayName;
        }

        updateHeaderUserName();

        function showAlert(message, type = 'ok') {
            const box = document.getElementById('alertBox');
            box.className = `alert ${type === 'error' ? 'err' : 'ok'}`;
            box.textContent = message;
            if (type !== 'error') {
                setTimeout(() => {
                    box.className = 'alert';
                    box.textContent = '';
                }, 4500);
            }
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function normalizeDateInput(value) {
            const raw = String(value || '').trim();
            if (!raw) return '';
            if (/^\d{4}-\d{2}-\d{2}/.test(raw)) {
                return raw.slice(0, 10);
            }
            const parsed = new Date(raw);
            if (Number.isNaN(parsed.getTime())) {
                return '';
            }
            return parsed.toISOString().slice(0, 10);
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });
            const rawText = await response.text();
            let data = {};
            if (rawText) {
                try {
                    data = JSON.parse(rawText);
                } catch (_) {
                    data = { success: false, message: rawText };
                }
            }
            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Errore richiesta API');
            }
            return data;
        }

        function formatDate(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return d.toLocaleDateString('it-IT');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return `${d.toLocaleDateString('it-IT')} ${d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(Number(value || 0));
        }

        async function fetchBlobWithAuth(url, fallbackMessage = 'Errore download file') {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                let message = fallbackMessage;
                try {
                    const text = (await response.text()).replace(/^\uFEFF/, '');
                    if (text) {
                        try {
                            const json = JSON.parse(text);
                            message = json.message || message;
                        } catch (_) {
                            message = text || message;
                        }
                    }
                } catch (_) {
                    // fallback: mantieni messaggio standard
                }
                throw new Error(message);
            }

            const blob = await response.blob();
            return { blob, response };
        }

        function sanitizeFilePart(value) {
            return String(value || 'QR').replace(/[^A-Za-z0-9-_]/g, '-');
        }

        function extractFilenameFromDisposition(disposition) {
            if (!disposition) {
                return '';
            }

            const utf8Match = disposition.match(/filename\*=UTF-8''([^;]+)/i);
            if (utf8Match && utf8Match[1]) {
                try {
                    return decodeURIComponent(utf8Match[1]).replace(/"/g, '').trim();
                } catch (_) {
                    return utf8Match[1].replace(/"/g, '').trim();
                }
            }

            const plainMatch = disposition.match(/filename="?([^\";]+)"?/i);
            if (plainMatch && plainMatch[1]) {
                return plainMatch[1].trim();
            }

            return '';
        }

        async function downloadQrPdf(acquistoId, qrCode = 'QR') {
            if (!acquistoId) {
                showAlert('ID acquisto non valido per download QR.', 'error');
                return;
            }

            try {
                const { blob, response } = await fetchBlobWithAuth(
                    `${API_URL}/qr.php?action=download&acquisto_id=${encodeURIComponent(acquistoId)}`,
                    'Errore download QR'
                );
                const disposition = response.headers.get('Content-Disposition') || '';
                const fallbackName = `QR_${sanitizeFilePart(qrCode)}.pdf`;
                const fileName = extractFilenameFromDisposition(disposition) || fallbackName;
                triggerBlobDownload(blob, fileName);
            } catch (error) {
                showAlert(error.message || 'Errore download QR PDF', 'error');
            }
        }

        function triggerBlobDownload(blob, filename) {
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(blobUrl);
        }

        async function downloadProtectedDocument(documentId, fallbackName = 'documento.pdf') {
            if (!documentId) {
                showAlert('Documento non valido.', 'error');
                return;
            }

            try {
                const { blob, response } = await fetchBlobWithAuth(
                    `${API_URL}/documenti-download.php?id=${encodeURIComponent(documentId)}`,
                    'Errore download documento'
                );
                const disposition = response.headers.get('Content-Disposition') || '';
                const fileName = extractFilenameFromDisposition(disposition) || fallbackName;
                triggerBlobDownload(blob, fileName);
            } catch (error) {
                showAlert(error.message || 'Errore download documento', 'error');
            }
        }

        async function downloadPrefilledDocument(typeId, typeName = 'documento') {
            if (!typeId) {
                showAlert('Tipo documento non valido.', 'error');
                return;
            }

            try {
                const { blob, response } = await fetchBlobWithAuth(
                    `${API_URL}/documenti-prefill.php?tipo_documento_id=${encodeURIComponent(typeId)}`,
                    'Errore generazione PDF precompilato'
                );
                const disposition = response.headers.get('Content-Disposition') || '';
                const fallbackName = `prefill_${sanitizeFilePart(typeName)}.pdf`;
                const fileName = extractFilenameFromDisposition(disposition) || fallbackName;
                triggerBlobDownload(blob, fileName);
            } catch (error) {
                showAlert(error.message || 'Errore download PDF precompilato', 'error');
            }
        }

        async function loadProfile() {
            const data = await fetchJson(`${API_URL}/auth.php?action=me`, { method: 'GET' });
            const profile = data.user || {};

            user = {
                ...(user || {}),
                id: profile.id || user?.id,
                email: profile.email || user?.email,
                nome: profile.nome || user?.nome,
                cognome: profile.cognome || user?.cognome,
                ruolo: profile.ruolo_nome || user?.ruolo,
                livello: Number(profile.ruolo_livello || user?.livello || 1),
            };
            localStorage.setItem('user', JSON.stringify(user));
            updateHeaderUserName();

            document.getElementById('profileNome').value = profile.nome || '';
            document.getElementById('profileCognome').value = profile.cognome || '';
            document.getElementById('profileEmail').value = profile.email || '';
            document.getElementById('profileTelefono').value = profile.telefono || '';
            document.getElementById('profileDataNascita').value = normalizeDateInput(profile.data_nascita);
            document.getElementById('profileCodiceFiscale').value = (profile.codice_fiscale || '').toUpperCase();
            document.getElementById('profileIndirizzo').value = profile.indirizzo || '';
            document.getElementById('profileCitta').value = profile.citta || '';
            document.getElementById('profileCap').value = profile.cap || '';
        }

        async function saveProfile(event) {
            event.preventDefault();

            const button = document.getElementById('saveProfileBtn');
            const payload = {
                nome: document.getElementById('profileNome').value.trim(),
                cognome: document.getElementById('profileCognome').value.trim(),
                email: document.getElementById('profileEmail').value.trim().toLowerCase(),
                telefono: document.getElementById('profileTelefono').value.trim(),
                data_nascita: document.getElementById('profileDataNascita').value.trim(),
                indirizzo: document.getElementById('profileIndirizzo').value.trim(),
                citta: document.getElementById('profileCitta').value.trim(),
                cap: document.getElementById('profileCap').value.trim(),
                codice_fiscale: document.getElementById('profileCodiceFiscale').value.trim().toUpperCase(),
            };

            button.disabled = true;
            button.textContent = 'Salvataggio...';

            try {
                const data = await fetchJson(`${API_URL}/auth.php?action=update-profile`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });

                if (data.token) {
                    token = data.token;
                    localStorage.setItem('token', token);
                }
                if (data.user) {
                    user = { ...(user || {}), ...data.user };
                    localStorage.setItem('user', JSON.stringify(user));
                    updateHeaderUserName();
                }

                showAlert(data.message || 'Profilo aggiornato.', 'ok');
                await loadDocuments();
            } catch (error) {
                showAlert(error.message || 'Errore aggiornamento profilo', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Salva dati profilo';
            }
        }

        function getStatusBadge(status) {
            if (status === 'confirmed') {
                return '<span class="badge badge-success">confermato</span>';
            }
            if (status === 'pending') {
                return '<span class="badge badge-warning">pending</span>';
            }
            return '<span class="badge badge-danger">annullato</span>';
        }

        function getLatestConfirmedPurchase() {
            const confirmed = myPurchases
                .filter(item => item.stato_pagamento === 'confirmed' && item.qr_code)
                .sort((a, b) => new Date(b.data_conferma || b.data_acquisto) - new Date(a.data_conferma || a.data_acquisto));
            return confirmed[0] || null;
        }

        function renderQrSection(purchase) {
            const section = document.getElementById('qrSection');
            if (!purchase) {
                section.innerHTML = '<p class="muted">Nessun QR disponibile. I pagamenti pending vengono attivati da segreteria.</p>';
                document.getElementById('statScadenza').textContent = '-';
                return;
            }

            const daysToExpire = purchase.data_scadenza
                ? Math.max(0, Math.ceil((new Date(purchase.data_scadenza) - new Date()) / 86400000))
                : '-';
            document.getElementById('statScadenza').textContent = daysToExpire;

            section.innerHTML = `
                <div class="qr-wrap">
                    <div class="qr-box" id="qrBox"></div>
                    <div>
                        <p><strong>Codice:</strong> <code>${escapeHtml(purchase.qr_code)}</code></p>
                        <p><strong>Pacchetto:</strong> ${escapeHtml(purchase.pacchetto_nome)}</p>
                        <p><strong>Scadenza:</strong> ${formatDate(purchase.data_scadenza)}</p>
                        <p><strong>Ingressi rimanenti:</strong> ${Number(purchase.ingressi_rimanenti || 0)}</p>
                        <p style="margin-top:10px;">
                            <button class="btn btn-primary" id="downloadQrBtn" type="button">Scarica PDF QR</button>
                        </p>
                    </div>
                </div>
            `;
            const downloadBtn = document.getElementById('downloadQrBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => downloadQrPdf(purchase.id, purchase.qr_code));
            }

            const qrTarget = document.getElementById('qrBox');
            if (!qrTarget) {
                return;
            }

            qrTarget.innerHTML = '<span class="small">Generazione QR in corso...</span>';

            if (activeQrBlobUrl) {
                URL.revokeObjectURL(activeQrBlobUrl);
                activeQrBlobUrl = '';
            }

            fetchBlobWithAuth(
                `${API_URL}/qr.php?action=svg&acquisto_id=${encodeURIComponent(purchase.id)}`,
                'Errore generazione QR'
            )
                .then(({ blob }) => {
                    activeQrBlobUrl = URL.createObjectURL(blob);
                    qrTarget.innerHTML = `<img src="${activeQrBlobUrl}" alt="QR code ${escapeHtml(purchase.qr_code)}">`;
                })
                .catch((error) => {
                    console.error(error);
                    qrTarget.innerHTML = '<span class="small">Errore durante la generazione del QR.</span>';
                    showAlert(error.message || 'Errore generazione QR', 'error');
                });
        }

        async function loadPackages() {
            const data = await fetchJson(`${API_URL}/pacchetti.php`, { method: 'GET' });
            const list = document.getElementById('packageList');

            if (!Array.isArray(data.pacchetti) || !data.pacchetti.length) {
                list.innerHTML = '<p class="muted">Nessun pacchetto disponibile.</p>';
                return;
            }

            list.innerHTML = data.pacchetti.map(pkg => `
                <div class="package-item">
                    <div class="package-meta">
                        <strong>${escapeHtml(pkg.nome)}</strong>
                        <p>${escapeHtml(pkg.descrizione || 'Pacchetto nuoto libero')}</p>
                        <p>${pkg.num_ingressi} ingressi - validita ${pkg.validita_giorni} giorni</p>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:700; margin-bottom:8px;">${formatCurrency(pkg.prezzo)}</div>
                        <button
                            class="btn btn-success js-buy-btn"
                            data-id="${pkg.id}"
                            data-name="${encodeURIComponent(pkg.nome)}"
                            data-price="${Number(pkg.prezzo)}"
                            type="button"
                        >Acquista</button>
                    </div>
                </div>
            `).join('');

            list.querySelectorAll('.js-buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    openPurchaseModal(
                        Number(button.dataset.id),
                        decodeURIComponent(button.dataset.name || ''),
                        Number(button.dataset.price || 0)
                    );
                });
            });
        }

        async function loadPurchases() {
            const data = await fetchJson(`${API_URL}/pacchetti.php?action=my-purchases`, { method: 'GET' });
            myPurchases = Array.isArray(data.acquisti) ? data.acquisti : [];

            const body = document.getElementById('purchasesBody');
            if (!myPurchases.length) {
                body.innerHTML = '<tr><td colspan="5">Nessun acquisto registrato.</td></tr>';
                renderQrSection(null);
                document.getElementById('statIngressi').textContent = '0';
                return;
            }

            body.innerHTML = myPurchases.map(item => {
                const downloadAction = item.stato_pagamento === 'confirmed' && item.qr_code
                    ? `<button class="btn btn-primary js-download-qr" type="button" data-id="${escapeHtml(item.id)}" data-code="${escapeHtml(item.qr_code)}">PDF QR</button>`
                    : '-';

                return `
                    <tr>
                        <td>${escapeHtml(item.pacchetto_nome)}</td>
                        <td>${formatDate(item.data_acquisto)}</td>
                        <td>${getStatusBadge(item.stato_pagamento)}</td>
                        <td>${item.ingressi_rimanenti} / ${item.num_ingressi || '-'}</td>
                        <td>${downloadAction}</td>
                    </tr>
                `;
            }).join('');
            body.querySelectorAll('.js-download-qr').forEach((button) => {
                button.addEventListener('click', () => {
                    downloadQrPdf(button.dataset.id || '', button.dataset.code || 'QR');
                });
            });

            const totalRemaining = myPurchases
                .filter(item => item.stato_pagamento === 'confirmed')
                .reduce((sum, item) => sum + Number(item.ingressi_rimanenti || 0), 0);

            document.getElementById('statIngressi').textContent = String(totalRemaining);
            renderQrSection(getLatestConfirmedPurchase());
        }

        async function loadCheckins() {
            const data = await fetchJson(`${API_URL}/checkin.php?action=history`, { method: 'GET' });
            const rows = Array.isArray(data.checkins) ? data.checkins : [];
            document.getElementById('statCheckin').textContent = String(rows.length);

            const body = document.getElementById('checkinBody');
            if (!rows.length) {
                body.innerHTML = '<tr><td colspan="4">Nessun check-in registrato.</td></tr>';
                return;
            }

            body.innerHTML = rows.slice(0, 15).map(row => `
                <tr>
                    <td>${formatDateTime(row.timestamp)}</td>
                    <td>${escapeHtml(row.fascia_oraria || '-')}</td>
                    <td>${escapeHtml(row.pacchetto_nome || '-')}</td>
                    <td>${escapeHtml((row.bagnino_nome || '-') + ' ' + (row.bagnino_cognome || ''))}</td>
                </tr>
            `).join('');
        }

        function getDocumentStatusBadge(status) {
            if (status === 'approved') {
                return '<span class="badge badge-success">approvato</span>';
            }
            if (status === 'pending') {
                return '<span class="badge badge-warning">in verifica</span>';
            }
            return '<span class="badge badge-danger">da correggere</span>';
        }

        function renderUploadedDocuments(rows) {
            const list = document.getElementById('uploadedDocsList');
            if (!Array.isArray(rows) || !rows.length) {
                list.innerHTML = '<p class="muted">Nessun documento caricato.</p>';
                return;
            }

            list.innerHTML = rows.map((row) => `
                <div class="doc-item">
                    <h5>${escapeHtml(row.tipo_nome || 'Documento')}</h5>
                    <p>Caricato: ${formatDate(row.data_caricamento)}</p>
                    ${row.note_revisione ? `<p>Note revisione: ${escapeHtml(row.note_revisione)}</p>` : ''}
                    <div class="doc-actions">
                        ${getDocumentStatusBadge(row.stato)}
                        <button
                            class="btn btn-primary btn-sm js-download-doc-btn"
                            type="button"
                            data-doc-id="${escapeHtml(row.id)}"
                            data-file-name="${encodeURIComponent(row.file_name || 'documento.pdf')}"
                        >Scarica</button>
                    </div>
                </div>
            `).join('');

            list.querySelectorAll('.js-download-doc-btn').forEach((button) => {
                button.addEventListener('click', () => {
                    const fileName = decodeURIComponent(button.dataset.fileName || 'documento.pdf');
                    downloadProtectedDocument(button.dataset.docId || '', fileName);
                });
            });
        }

        function renderMissingDocuments(rows) {
            const list = document.getElementById('missingDocsList');
            if (!Array.isArray(rows) || !rows.length) {
                list.innerHTML = '<p class="muted">Ottimo: non risultano documenti obbligatori mancanti.</p>';
                return;
            }

            list.innerHTML = rows.map((row) => {
                const typeId = Number(row.id || 0);
                const inputId = `docUploadType${typeId}`;
                const moduloButton = (!row.is_medical && row.modulo_download_url)
                    ? `<a class="btn btn-secondary btn-sm" href="${escapeHtml(row.modulo_download_url)}" target="_blank" rel="noopener">Scarica modulo</a>`
                    : '';
                const prefillButton = (!row.is_medical && row.prefill_download_url)
                    ? `<button class="btn btn-light btn-sm js-prefill-btn" type="button" data-type-id="${typeId}" data-type-name="${encodeURIComponent(row.nome || 'documento')}">PDF precompilato</button>`
                    : '';
                const noteText = row.is_medical
                    ? '<p>Certificato medico: deve essere rilasciato dal medico e poi caricato.</p>'
                    : '<p>Scarica, compila online o a mano, firma e carica il documento.</p>';

                return `
                    <div class="doc-item">
                        <h5>${escapeHtml(row.nome || 'Documento')}</h5>
                        <p>${escapeHtml(row.descrizione || '')}</p>
                        ${noteText}
                        <div class="doc-actions">
                            ${moduloButton}
                            ${prefillButton}
                        </div>
                        <div class="doc-upload">
                            <input id="${inputId}" type="file" accept=".pdf,.jpg,.jpeg,.png">
                            <button
                                class="btn btn-success btn-sm js-upload-doc-btn"
                                type="button"
                                data-type-id="${typeId}"
                                data-type-name="${encodeURIComponent(row.nome || 'documento')}"
                                data-input-id="${inputId}"
                            >Carica firmato</button>
                        </div>
                    </div>
                `;
            }).join('');

            list.querySelectorAll('.js-upload-doc-btn').forEach((button) => {
                button.addEventListener('click', () => {
                    uploadDocumentForType(
                        Number(button.dataset.typeId || 0),
                        button.dataset.inputId || '',
                        decodeURIComponent(button.dataset.typeName || 'documento')
                    );
                });
            });

            list.querySelectorAll('.js-prefill-btn').forEach((button) => {
                button.addEventListener('click', () => {
                    downloadPrefilledDocument(
                        Number(button.dataset.typeId || 0),
                        decodeURIComponent(button.dataset.typeName || 'documento')
                    );
                });
            });
        }

        async function uploadDocumentForType(typeId, inputId, typeName) {
            if (!typeId || !inputId) {
                showAlert('Tipo documento non valido.', 'error');
                return;
            }

            const input = document.getElementById(inputId);
            const file = input?.files?.[0];
            if (!file) {
                showAlert(`Seleziona prima il file per "${typeName}".`, 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showAlert('File troppo grande (max 5MB).', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('tipo_documento_id', String(typeId));
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/documenti.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Errore upload documento');
                }

                showAlert(data.message || 'Documento caricato con successo.', 'ok');
                input.value = '';
                await loadDocuments();
            } catch (error) {
                showAlert(error.message || 'Errore upload documento', 'error');
            }
        }

        async function loadDocuments() {
            const data = await fetchJson(`${API_URL}/documenti.php`, { method: 'GET' });
            const uploadedRows = Array.isArray(data.documenti) ? data.documenti : [];
            const missingRows = Array.isArray(data.documenti_mancanti) ? data.documenti_mancanti : [];

            document.getElementById('missingDocs').textContent = String(
                Number(data.documenti_obbligatori_mancanti || missingRows.length || 0)
            );

            renderUploadedDocuments(uploadedRows);
            renderMissingDocuments(missingRows);
        }

        function openPurchaseModal(id, name, price) {
            selectedPackage = { id, name, price };
            document.getElementById('purchaseTitle').textContent = `Richiesta pacchetto: ${name}`;
            document.getElementById('purchaseMeta').textContent = `Contributo: ${formatCurrency(price)} - Seleziona la modalità di conferma.`;
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNote').value = '';
            document.querySelector('input[name="paymentMethod"][value="bonifico"]').checked = true;
            updatePaymentHint();
            document.getElementById('purchaseOverlay').classList.add('open');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseOverlay').classList.remove('open');
            selectedPackage = null;
        }

        function updatePaymentHint() {
            const method = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'bonifico';
            const hint = document.getElementById('paymentHint');

            if (method === 'bonifico') {
                hint.textContent = 'Con bonifico la richiesta resta in attesa finché la segreteria conferma il pagamento.';
                return;
            }

            hint.textContent = 'In struttura: conferma amministrativa in reception prima dell\'attivazione del pacchetto.';
        }

        async function confirmPurchase() {
            if (!selectedPackage) return;

            const method = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'bonifico';
            const reference = document.getElementById('paymentReference').value.trim();
            const note = document.getElementById('paymentNote').value.trim();
            const button = document.getElementById('confirmPurchaseBtn');

            if (method === 'bonifico' && reference.length < 3) {
                showAlert('Inserisci un riferimento bonifico valido.', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'Elaborazione...';

            try {
                const payload = {
                    pacchetto_id: selectedPackage.id,
                    metodo_pagamento: method,
                    riferimento_pagamento: reference,
                    note_pagamento: note
                };

                const data = await fetchJson(`${API_URL}/pacchetti.php`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                showAlert(data.message || 'Richiesta registrata.', 'ok');
                closePurchaseModal();
                await loadPurchases();
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Conferma richiesta';
            }
        }

        function logout() {
            if (activeQrBlobUrl) {
                URL.revokeObjectURL(activeQrBlobUrl);
                activeQrBlobUrl = '';
            }
            localStorage.clear();
            window.location.href = '../login.html';
        }

        document.getElementById('profileForm').addEventListener('submit', saveProfile);

        document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
            input.addEventListener('change', updatePaymentHint);
        });

        document.getElementById('purchaseOverlay').addEventListener('click', (event) => {
            if (event.target.id === 'purchaseOverlay') {
                closePurchaseModal();
            }
        });

        async function refreshRuntimeData() {
            await Promise.allSettled([loadPurchases(), loadCheckins(), loadDocuments()]);
        }

        Promise.all([loadProfile(), loadPackages(), loadPurchases(), loadCheckins(), loadDocuments()])
            .catch(error => showAlert(error.message, 'error'));

        setInterval(() => {
            refreshRuntimeData();
        }, 30000);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                refreshRuntimeData();
            }
        });

        window.openPurchaseModal = openPurchaseModal;
        window.closePurchaseModal = closePurchaseModal;
        window.confirmPurchase = confirmPurchase;
        window.downloadQrPdf = downloadQrPdf;
        window.logout = logout;
    </script>
</body>
</html>
