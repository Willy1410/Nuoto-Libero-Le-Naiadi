<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ufficio</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#f3f4f6;color:#111827}
.header{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:28px}.container{max-width:1320px;margin:20px auto;padding:0 14px}
.btn{border:none;border-radius:8px;padding:8px 11px;font-weight:600;cursor:pointer;color:#fff;font-size:12px}.btn-danger{background:#dc2626}.btn-primary{background:#2563eb}.btn-success{background:#059669}.btn-warning{background:#d97706}.btn-outline{background:#fff;color:#111827;border:1px solid #d1d5db}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-bottom:14px}.stat{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border-radius:10px;padding:12px;text-align:center}.stat b{font-size:26px}
.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px}.tab{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:7px 12px;cursor:pointer;font-weight:600}.tab.active{color:#d97706;border-color:#d97706}
.pane{display:none}.pane.active{display:block}.tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}.tools input,.tools select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
.table-wrap{overflow:auto}.t{width:100%;border-collapse:collapse;min-width:660px}.t th{background:#f9fafb;font-size:12px;text-align:left;padding:8px;border-bottom:1px solid #e5e7eb}.t td{padding:8px;border-bottom:1px solid #f0f0f0;font-size:13px;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}.ok{background:#d1fae5;color:#065f46}.warn{background:#fef3c7;color:#92400e}.err{background:#fee2e2;color:#991b1b}
.actions{display:flex;gap:6px;flex-wrap:wrap}.alert{padding:9px 11px;border-radius:8px;margin-bottom:10px;font-weight:600}.alert.success{background:#d1fae5;color:#065f46}.alert.error{background:#fee2e2;color:#991b1b}
</style>
</head>
<body>
<div class="header"><div><h1>Dashboard Ufficio</h1><small id="uname"></small></div><button class="btn btn-danger" onclick="logout()">Esci</button></div>
<div class="container">
<div id="alerts"></div>
<div class="stats">
<div class="stat"><b id="s_pending">0</b><div>Acquisti Pending</div></div>
<div class="stat"><b id="s_docs">0</b><div>Documenti Pending</div></div>
<div class="stat"><b id="s_today">0</b><div>Check-in Oggi</div></div>
<div class="stat"><b id="s_revenue">EUR 0</b><div>Incassi Mese</div></div>
</div>
<div class="card">
<div class="tabs">
<button class="tab active" data-pane="purchases">Acquisti Pending</button>
<button class="tab" data-pane="docs">Documenti</button>
<button class="tab" data-pane="modules">Moduli</button>
<button class="tab" data-pane="report">Report</button>
</div>
<div id="p_purchases" class="pane active"><div class="table-wrap"><table class="t"><thead><tr><th>Utente</th><th>Pacchetto</th><th>Importo</th><th>Metodo</th><th>Data</th><th>Azioni</th></tr></thead><tbody id="tb_purchases"></tbody></table></div></div>
<div id="p_docs" class="pane"><div class="table-wrap"><table class="t"><thead><tr><th>Utente</th><th>Tipo</th><th>Data</th><th>Stato</th><th>Azioni</th></tr></thead><tbody id="tb_docs"></tbody></table></div></div>
<div id="p_modules" class="pane">
<form id="moduleForm" class="tools" enctype="multipart/form-data" style="margin-bottom:12px">
<select id="m_template" required onchange="applyModuleTemplate()">
<option value="">Seleziona modulo da aggiornare</option>
<option value="modulo-iscrizione" data-nome="Modulo Iscrizione" data-target="moduli.html -> card Modulo Iscrizione Nuoto Libero">Modulo Iscrizione (modulo-iscrizione)</option>
<option value="regolamento-piscina" data-nome="Regolamento Piscina" data-target="moduli.html -> card Regolamento Piscina">Regolamento Piscina (regolamento-piscina)</option>
<option value="informativa-privacy" data-nome="Informativa Privacy" data-target="moduli.html -> card Informativa Privacy">Informativa Privacy (informativa-privacy)</option>
<option value="certificato-medico-info" data-nome="Certificato Medico - Indicazioni" data-target="moduli.html -> card Certificato Medico - Indicazioni">Certificato Medico - Indicazioni (certificato-medico-info)</option>
<option value="liberatoria-minori" data-nome="Liberatoria per Minori" data-target="moduli.html -> card Liberatoria per Minori">Liberatoria per Minori (liberatoria-minori)</option>
<option value="listino-prezzi" data-nome="Listino Prezzi Completo" data-target="moduli.html -> card Listino Prezzi Completo">Listino Prezzi Completo (listino-prezzi)</option>
</select>
<input id="m_slug" name="slug" placeholder="Slug modulo" required readonly>
<input id="m_name" name="nome" placeholder="Nome modulo" required readonly>
<input id="m_target" placeholder="Dove appare nel sito" readonly>
<input id="m_file" name="file" type="file" accept=".pdf,.doc,.docx" required>
<label style="display:flex;align-items:center;gap:6px;font-size:12px;"><input id="m_replace" name="replace" type="checkbox" value="1">Sostituisci se esiste</label>
<button class="btn btn-primary" type="submit">Carica modulo</button>
</form>
<div class="table-wrap"><table class="t"><thead><tr><th>Nome</th><th>Slug</th><th>File</th><th>Aggiornato</th><th>Caricato da</th><th>Azioni</th></tr></thead><tbody id="tb_modules"></tbody></table></div>
</div>
<div id="p_report" class="pane">
<div class="tools"><input type="date" id="repDate"><button class="btn btn-primary" onclick="loadDaily()">Carica report giornaliero</button></div>
<div id="dailySummary" style="font-size:14px;margin-bottom:8px"></div>
<div class="table-wrap"><table class="t"><thead><tr><th>Ora</th><th>Utente</th><th>Fascia</th><th>Bagnino</th></tr></thead><tbody id="tb_daily"></tbody></table></div>
</div>
</div>
</div>
<script>
const API='../api';const TOKEN=localStorage.getItem('token');const USER=JSON.parse(localStorage.getItem('user')||'{}');if(!TOKEN||!(USER.ruolo==='ufficio'||USER.ruolo==='segreteria'||USER.ruolo==='admin'))location.href='../login.html';
uname.textContent=`${USER.nome||''} ${USER.cognome||''}`.trim();repDate.value=new Date().toISOString().split('T')[0];
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));btn.classList.add('active');document.getElementById('p_'+btn.dataset.pane).classList.add('active');}));
const moduleForm=document.getElementById('moduleForm');if(moduleForm){moduleForm.addEventListener('submit',submitModuleForm);}applyModuleTemplate();
function alertBox(m,t='success'){alerts.innerHTML=`<div class="alert ${t}">${m}</div>`;if(t==='success')setTimeout(()=>alerts.innerHTML='',3200)}
function eur(v){return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(v||0));}
async function api(url,opt={}){const r=await fetch(url,{...opt,headers:{Authorization:`Bearer ${TOKEN}`,...(opt.headers||{})}});const tx=await r.text();let d={};try{d=JSON.parse(tx);}catch(e){throw new Error('Risposta API non valida')}if(!r.ok||d.success===false)throw new Error(d.message||`Errore ${r.status}`);return d}async function loadStats(){const d=await api(`${API}/stats.php?action=dashboard`);s_pending.textContent=d.stats.acquisti_pending;s_docs.textContent=d.stats.documenti_pending;s_today.textContent=d.stats.checkin_oggi;s_revenue.textContent=eur(d.stats.incassi_mese)}
async function loadPurchases(){try{const d=await api(`${API}/pacchetti.php?action=pending`);tb_purchases.innerHTML=(d.acquisti||[]).map(a=>`<tr><td>${a.user_nome} ${a.user_cognome}<br><small>${a.user_email}</small></td><td>${a.pacchetto_nome}</td><td>${eur(a.importo_pagato)}</td><td>${a.metodo_pagamento}</td><td>${new Date(a.data_acquisto).toLocaleString('it-IT')}</td><td><div class="actions"><button class="btn btn-success" onclick="confirmPurchase('${a.id}')">Conferma</button><button class="btn btn-danger" onclick="cancelPurchase('${a.id}')">Annulla</button></div></td></tr>`).join('')||'<tr><td colspan="6">Nessun acquisto pending</td></tr>';}catch(e){alertBox(e.message,'error')}}
async function confirmPurchase(id){if(!confirm('Confermare pagamento?'))return;try{const d=await api(`${API}/pacchetti.php?action=confirm&id=${encodeURIComponent(id)}`,{method:'PATCH'});alertBox(d.message||'Confermato');await loadStats();await loadPurchases();}catch(e){alertBox(e.message,'error')}}
async function cancelPurchase(id){if(!confirm('Annullare acquisto?'))return;try{const d=await api(`${API}/pacchetti.php?action=cancel&id=${encodeURIComponent(id)}`,{method:'PATCH'});alertBox(d.message||'Annullato');await loadStats();await loadPurchases();}catch(e){alertBox(e.message,'error')}}
async function loadDocs(){try{const d=await api(`${API}/documenti.php?action=pending`);tb_docs.innerHTML=(d.documenti||[]).map(x=>`<tr><td>${x.user_nome} ${x.user_cognome}</td><td>${x.tipo_nome}</td><td>${new Date(x.data_caricamento).toLocaleDateString('it-IT')}</td><td><span class="badge warn">pending</span></td><td><div class="actions"><a class="btn btn-outline" href="${x.file_url}" target="_blank" rel="noopener">Apri</a><button class="btn btn-success" onclick="reviewDoc('${x.id}','approved')">Approva</button><button class="btn btn-danger" onclick="reviewDoc('${x.id}','rejected')">Rifiuta</button></div></td></tr>`).join('')||'<tr><td colspan="5">Nessun documento</td></tr>';}catch(e){alertBox(e.message,'error')}}
async function reviewDoc(id,s){let n='';if(s==='rejected'){n=prompt('Motivo rifiuto');if(!n)return;}try{const d=await api(`${API}/documenti.php?action=review&id=${encodeURIComponent(id)}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({stato:s,note_revisione:n})});alertBox(d.message||'Documento aggiornato');await loadStats();await loadDocs();}catch(e){alertBox(e.message,'error')}}
async function loadModules(){try{const d=await api(`${API}/moduli.php`);tb_modules.innerHTML=(d.moduli||[]).map(m=>`<tr><td>${m.nome}<br><small>v${m.version_num}</small></td><td><code>${m.slug}</code></td><td>${m.original_name}<br><small>${Number(m.size_kb||0).toFixed(2)} KB</small></td><td>${new Date(m.updated_at).toLocaleString('it-IT')}</td><td>${m.uploader_nome} ${m.uploader_cognome}</td><td><div class="actions"><a class="btn btn-outline" href="${m.download_url}" target="_blank" rel="noopener">Scarica</a><button class="btn btn-warning" onclick="prefillReplace('${m.slug.replace(/'/g,"\\'")}','${m.nome.replace(/'/g,"\\'")}')">Sostituisci</button><button class="btn btn-danger" onclick="deleteModulo(${m.id})">Elimina</button></div></td></tr>`).join('')||'<tr><td colspan="6">Nessun modulo caricato</td></tr>';}catch(e){alertBox(e.message,'error')}}
function applyModuleTemplate(){const s=document.getElementById('m_template');const target=document.getElementById('m_target');if(!s)return;const o=s.options[s.selectedIndex];if(!o||!o.value){m_slug.value='';m_name.value='';if(target)target.value='';return;}m_slug.value=o.value;m_name.value=o.dataset.nome||'';if(target)target.value=o.dataset.target||''}
function prefillReplace(slug,nome){const s=document.getElementById('m_template');const target=document.getElementById('m_target');if(s){const opt=[...s.options].find(x=>x.value===slug);if(opt){s.value=slug;applyModuleTemplate();}else{s.value='';m_slug.value=slug;m_name.value=nome;if(target)target.value='Slug personalizzato (non mappato nel menu)';}}m_name.value=nome;m_replace.checked=true;m_file.focus()}
async function submitModuleForm(e){e.preventDefault();const slug=m_slug.value.trim();const nome=m_name.value.trim();const file=m_file.files[0];if(!slug||!nome||!file){alertBox('Compila slug, nome e file','error');return;}const fd=new FormData();fd.append('slug',slug);fd.append('nome',nome);fd.append('replace',m_replace.checked?'1':'0');fd.append('file',file);try{const r=await fetch(`${API}/moduli.php`,{method:'POST',headers:{Authorization:`Bearer ${TOKEN}`},body:fd});const t=await r.text();let d={};try{d=JSON.parse(t);}catch(x){throw new Error('Risposta API non valida')}if(!r.ok||d.success===false)throw new Error(d.message||'Errore upload modulo');alertBox(d.message||'Modulo salvato');moduleForm.reset();applyModuleTemplate();await loadModules();}catch(err){alertBox(err.message,'error')}}
async function deleteModulo(id){if(!confirm('Confermi eliminazione modulo?'))return;try{const d=await api(`${API}/moduli.php?id=${encodeURIComponent(id)}`,{method:'DELETE'});alertBox(d.message||'Modulo eliminato');await loadModules();}catch(e){alertBox(e.message,'error')}}
async function loadDaily(){try{const date=repDate.value;const d=await api(`${API}/stats.php?action=report-daily&data=${encodeURIComponent(date)}`);dailySummary.textContent=`Totale check-in: ${d.totale} (Mattina: ${d.mattina}, Pomeriggio: ${d.pomeriggio})`;tb_daily.innerHTML=(d.checkins||[]).map(c=>`<tr><td>${new Date(c.timestamp).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}</td><td>${c.nome} ${c.cognome}</td><td>${c.fascia_oraria}</td><td>${c.bagnino_nome} ${c.bagnino_cognome}</td></tr>`).join('')||'<tr><td colspan="4">Nessun check-in</td></tr>';}catch(e){alertBox(e.message,'error')}}
function logout(){localStorage.clear();location.href='../login.html'}
async function init(){try{await loadStats();await loadPurchases();await loadDocs();await loadModules();await loadDaily();}catch(e){alertBox(e.message,'error')}}init();
</script>
</body>
</html>
