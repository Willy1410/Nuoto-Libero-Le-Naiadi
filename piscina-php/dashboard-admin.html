<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#f3f4f6;color:#111827}
.header{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:28px}.container{max-width:1400px;margin:20px auto;padding:0 14px}
.btn{border:none;border-radius:8px;padding:8px 11px;font-weight:600;cursor:pointer;color:#fff;font-size:12px}
.btn-danger{background:#dc2626}.btn-primary{background:#2563eb}.btn-success{background:#059669}.btn-warning{background:#d97706}.btn-muted{background:#6b7280}.btn-outline{background:#fff;color:#111827;border:1px solid #d1d5db}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:14px}
.stat{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;border-radius:10px;padding:12px;text-align:center}.stat b{font-size:26px}
.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px}
.tab{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:7px 12px;cursor:pointer;font-weight:600}.tab.active{color:#dc2626;border-color:#dc2626}
.pane{display:none}.pane.active{display:block}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}.tools input,.tools select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
.table-wrap{overflow:auto}.t{width:100%;border-collapse:collapse;min-width:700px}.t th{background:#f9fafb;font-size:12px;text-align:left;padding:8px;border-bottom:1px solid #e5e7eb}.t td{padding:8px;border-bottom:1px solid #f0f0f0;font-size:13px;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}.ok{background:#d1fae5;color:#065f46}.warn{background:#fef3c7;color:#92400e}.err{background:#fee2e2;color:#991b1b}.muted{background:#e5e7eb;color:#374151}
.actions{display:flex;gap:6px;flex-wrap:wrap}.alert{padding:9px 11px;border-radius:8px;margin-bottom:10px;font-weight:600}.alert.success{background:#d1fae5;color:#065f46}.alert.error{background:#fee2e2;color:#991b1b}
svg{width:100%;height:220px;display:block;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="header"><div><h1>Dashboard Admin</h1><small id="uname"></small></div><button class="btn btn-danger" onclick="logout()">Esci</button></div>
<div class="container">
<div id="alerts"></div>
<div class="stats">
<div class="stat"><b id="s_users">0</b><div>Utenti</div></div>
<div class="stat"><b id="s_today">0</b><div>Check-in Oggi</div></div>
<div class="stat"><b id="s_month">0</b><div>Check-in Mese</div></div>
<div class="stat"><b id="s_revenue">EUR 0</b><div>Incassi Mese</div></div>
<div class="stat"><b id="s_pending">0</b><div>Pending</div></div>
<div class="stat"><b id="s_exp">0</b><div>In Scadenza</div></div>
</div>
<div class="card">
<div class="tabs">
<button class="tab active" data-pane="overview">Panoramica</button>
<button class="tab" data-pane="users">Utenti</button>
<button class="tab" data-pane="purchases">Acquisti</button>
<button class="tab" data-pane="docs">Documenti</button>
<button class="tab" data-pane="report">Report</button>
</div>
<div id="p_overview" class="pane active">
<div class="table-wrap"><table class="t"><thead><tr><th>Data/Ora</th><th>Utente</th><th>Fascia</th><th>Pacchetto</th></tr></thead><tbody id="tb_overview"></tbody></table></div>
</div>
<div id="p_users" class="pane">
<div class="tools">
<input id="q_user" placeholder="Cerca utenti...">
<select id="f_role"><option value="">Ruolo</option><option value="utente">Utente</option><option value="bagnino">Bagnino</option><option value="ufficio">Ufficio</option><option value="admin">Admin</option></select>
<select id="f_active"><option value="">Stato</option><option value="1">Attivi</option><option value="0">Disattivi</option></select>
<button class="btn btn-primary" onclick="loadUsers()">Filtra</button>
<button class="btn btn-success" onclick="toggleCreate(true)">+ Utente</button>
</div>
<div id="createBox" class="hidden" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-bottom:10px;background:#fafafa">
<div class="tools">
<input id="n_nome" placeholder="Nome"><input id="n_cognome" placeholder="Cognome"><input id="n_email" placeholder="Email"><input id="n_tel" placeholder="Telefono"><input id="n_pwd" placeholder="Password temp"><select id="n_role"><option value="utente">Utente</option><option value="bagnino">Bagnino</option><option value="ufficio">Ufficio</option><option value="admin">Admin</option></select>
<button class="btn btn-success" onclick="createUser()">Salva</button><button class="btn btn-muted" onclick="toggleCreate(false)">Annulla</button>
</div>
</div>
<div class="table-wrap"><table class="t"><thead><tr><th>Nome</th><th>Email</th><th>Ruolo</th><th>Stato</th><th>Ingressi</th><th>Check-in</th><th>Azioni</th></tr></thead><tbody id="tb_users"></tbody></table></div>
</div><div id="p_purchases" class="pane">
<div class="table-wrap"><table class="t"><thead><tr><th>Utente</th><th>Pacchetto</th><th>Importo</th><th>Metodo</th><th>Data</th><th>Azioni</th></tr></thead><tbody id="tb_purchases"></tbody></table></div>
</div>
<div id="p_docs" class="pane">
<div class="table-wrap"><table class="t"><thead><tr><th>Utente</th><th>Tipo</th><th>Data</th><th>Stato</th><th>Azioni</th></tr></thead><tbody id="tb_docs"></tbody></table></div>
</div>
<div id="p_report" class="pane">
<div class="tools">
<select id="r_metric"><option value="entrate">Entrate</option><option value="checkin">Check-in</option><option value="pagamenti">Pagamenti</option></select>
<select id="r_period" onchange="toggleRange()"><option value="7d">7 giorni</option><option value="30d" selected>30 giorni</option><option value="3m">3 mesi</option><option value="custom">Personalizzato</option></select>
<input id="r_from" type="date" class="hidden"><input id="r_to" type="date" class="hidden">
<button class="btn btn-primary" onclick="loadReport()">Aggiorna</button>
<button class="btn btn-success" onclick="exportUsers()">Export utenti CSV</button>
</div>
<svg id="chart" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
<div style="display:flex;justify-content:space-between;font-size:12px;color:#4b5563;margin:6px 2px"><span id="c_start">-</span><span id="c_max">max: -</span><span id="c_end">-</span></div>
<div class="table-wrap" style="margin-top:10px"><table class="t" style="min-width:400px"><thead><tr><th>Metodo pagamento</th><th>Numero</th><th>Totale</th></tr></thead><tbody id="tb_breakdown"></tbody></table></div>
</div>
</div>
</div>
<script>
const API='../api';
const TOKEN=localStorage.getItem('token');
const USER=JSON.parse(localStorage.getItem('user')||'{}');
if(!TOKEN||USER.ruolo!=='admin'){location.href='../login.html';}
document.getElementById('uname').textContent=`${USER.nome||''} ${USER.cognome||''}`.trim();

document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));btn.classList.add('active');document.getElementById('p_'+btn.dataset.pane).classList.add('active');}));

function alertBox(msg,type='success'){const b=document.getElementById('alerts');b.innerHTML=`<div class="alert ${type}">${msg}</div>`;if(type==='success'){setTimeout(()=>b.innerHTML='',3200);}}
function eur(v){return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(v||0));}

async function api(url,opt={}){const res=await fetch(url,{...opt,headers:{Authorization:`Bearer ${TOKEN}`,...(opt.headers||{})}});const t=await res.text();let d={};try{d=JSON.parse(t);}catch(e){throw new Error('Risposta API non valida');}if(!res.ok||d.success===false){throw new Error(d.message||`Errore ${res.status}`);}return d;}

async function loadStats(){const d=await api(`${API}/stats.php?action=dashboard`);document.getElementById('s_users').textContent=d.stats.totale_utenti;document.getElementById('s_today').textContent=d.stats.checkin_oggi;document.getElementById('s_month').textContent=d.stats.checkin_mese;document.getElementById('s_revenue').textContent=eur(d.stats.incassi_mese);document.getElementById('s_pending').textContent=d.stats.acquisti_pending;document.getElementById('s_exp').textContent=d.stats.pacchetti_in_scadenza;document.getElementById('tb_overview').innerHTML=(d.ultimi_checkin||[]).map(x=>`<tr><td>${new Date(x.timestamp).toLocaleString('it-IT')}</td><td>${x.nome} ${x.cognome}</td><td>${x.fascia_oraria}</td><td>${x.pacchetto_nome}</td></tr>`).join('')||'<tr><td colspan="4">Nessun check-in</td></tr>'}
function toggleCreate(s){document.getElementById('createBox').classList.toggle('hidden',!s)}

async function createUser(){const p={nome:n_nome.value.trim(),cognome:n_cognome.value.trim(),email:n_email.value.trim(),telefono:n_tel.value.trim(),password:n_pwd.value,ruolo:n_role.value};try{await api(`${API}/admin.php?action=create-user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});alertBox('Utente creato');toggleCreate(false);['n_nome','n_cognome','n_email','n_tel','n_pwd'].forEach(i=>document.getElementById(i).value='');await loadUsers();await loadStats();}catch(e){alertBox(e.message,'error')}}

async function loadUsers(){const q=encodeURIComponent(q_user.value.trim()),r=encodeURIComponent(f_role.value),a=encodeURIComponent(f_active.value);try{const d=await api(`${API}/admin.php?action=users&q=${q}&role=${r}&active=${a}`);tb_users.innerHTML=(d.users||[]).map(u=>`<tr><td>${u.nome} ${u.cognome}</td><td>${u.email}<br><small>${u.telefono||'-'}</small></td><td><span class="badge muted">${u.ruolo}</span></td><td>${Number(u.attivo)===1?'<span class="badge ok">attivo</span>':'<span class="badge err">disattivo</span>'}</td><td>${Number(u.ingressi_totali_rimanenti||0)}</td><td>${Number(u.totale_checkin||0)}</td><td><div class="actions"><button class="btn btn-primary" onclick="userDetail('${u.id}')">Dettaglio</button><button class="btn btn-warning" onclick="editUser('${u.id}','${u.nome}','${u.cognome}','${u.email}','${u.telefono||''}','${u.ruolo}')">Modifica</button><button class="btn btn-muted" onclick="toggleUser('${u.id}')">Attiva/Disattiva</button><button class="btn btn-danger" onclick="deleteUser('${u.id}')">Elimina</button></div></td></tr>`).join('')||'<tr><td colspan="7">Nessun utente</td></tr>';}catch(e){alertBox(e.message,'error')}}

async function editUser(id,n,c,e,t,r){const nn=prompt('Nome',n);if(nn===null)return;const nc=prompt('Cognome',c);if(nc===null)return;const ne=prompt('Email',e);if(ne===null)return;const nt=prompt('Telefono',t);if(nt===null)return;const nr=prompt('Ruolo (utente,bagnino,ufficio,admin)',r);if(nr===null)return;try{await api(`${API}/admin.php?action=update-user&id=${encodeURIComponent(id)}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({nome:nn.trim(),cognome:nc.trim(),email:ne.trim(),telefono:nt.trim(),ruolo:nr.trim()})});alertBox('Utente aggiornato');await loadUsers();}catch(err){alertBox(err.message,'error')}}
async function toggleUser(id){try{await api(`${API}/admin.php?action=toggle-user&id=${encodeURIComponent(id)}`,{method:'PATCH'});alertBox('Stato aggiornato');await loadUsers();}catch(e){alertBox(e.message,'error')}}
async function deleteUser(id){if(!confirm('Confermi eliminazione utente?'))return;try{await api(`${API}/admin.php?action=delete-user&id=${encodeURIComponent(id)}&confirm=yes`,{method:'DELETE'});alertBox('Utente eliminato');await loadUsers();await loadStats();}catch(e){alertBox(e.message,'error')}}
async function userDetail(id){try{const d=await api(`${API}/admin.php?action=user-detail&id=${encodeURIComponent(id)}`);const u=d.user;const pkg=(d.pacchetti||[]).map(p=>`${p.pacchetto_nome}: ${p.ingressi_rimanenti}/${p.num_ingressi} (${p.stato_pagamento})`).join('\n')||'Nessun pacchetto';const chk=(d.checkins||[]).length;const pay=(d.pagamenti||[]).map(p=>`${p.metodo} ${eur(p.importo)} ${p.stato}`).join('\n')||'Nessun pagamento';alert(`Utente: ${u.nome} ${u.cognome}\nEmail: ${u.email}\nRuolo: ${u.ruolo}\nCheck-in: ${chk}\n\nPacchetti:\n${pkg}\n\nPagamenti:\n${pay}`);}catch(e){alertBox(e.message,'error')}}

async function loadPurchases(){try{const d=await api(`${API}/pacchetti.php?action=pending`);tb_purchases.innerHTML=(d.acquisti||[]).map(a=>`<tr><td>${a.user_nome} ${a.user_cognome}<br><small>${a.user_email}</small></td><td>${a.pacchetto_nome}</td><td>${eur(a.importo_pagato)}</td><td>${a.metodo_pagamento}</td><td>${new Date(a.data_acquisto).toLocaleString('it-IT')}</td><td><div class="actions"><button class="btn btn-success" onclick="confirmPurchase('${a.id}')">Conferma</button><button class="btn btn-danger" onclick="cancelPurchase('${a.id}')">Annulla</button></div></td></tr>`).join('')||'<tr><td colspan="6">Nessun acquisto pending</td></tr>';}catch(e){alertBox(e.message,'error')}}
async function confirmPurchase(id){if(!confirm('Confermare pagamento?'))return;try{const d=await api(`${API}/pacchetti.php?action=confirm&id=${encodeURIComponent(id)}`,{method:'PATCH'});alertBox(d.message||'Confermato');await loadPurchases();await loadStats();}catch(e){alertBox(e.message,'error')}}
async function cancelPurchase(id){if(!confirm('Annullare acquisto?'))return;try{const d=await api(`${API}/pacchetti.php?action=cancel&id=${encodeURIComponent(id)}`,{method:'PATCH'});alertBox(d.message||'Annullato');await loadPurchases();await loadStats();}catch(e){alertBox(e.message,'error')}}

async function loadDocs(){try{const d=await api(`${API}/documenti.php?action=pending`);tb_docs.innerHTML=(d.documenti||[]).map(x=>`<tr><td>${x.user_nome} ${x.user_cognome}</td><td>${x.tipo_nome}</td><td>${new Date(x.data_caricamento).toLocaleDateString('it-IT')}</td><td><span class="badge warn">pending</span></td><td><div class="actions"><a class="btn btn-outline" href="${x.file_url}" target="_blank" rel="noopener">Apri</a><button class="btn btn-success" onclick="reviewDoc('${x.id}','approved')">Approva</button><button class="btn btn-danger" onclick="reviewDoc('${x.id}','rejected')">Rifiuta</button></div></td></tr>`).join('')||'<tr><td colspan="5">Nessun documento</td></tr>';}catch(e){alertBox(e.message,'error')}}
async function reviewDoc(id,s){let n='';if(s==='rejected'){n=prompt('Motivo rifiuto');if(!n)return;}try{const d=await api(`${API}/documenti.php?action=review&id=${encodeURIComponent(id)}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({stato:s,note_revisione:n})});alertBox(d.message||'Documento aggiornato');await loadDocs();await loadStats();}catch(e){alertBox(e.message,'error')}}

function toggleRange(){const c=r_period.value==='custom';r_from.classList.toggle('hidden',!c);r_to.classList.toggle('hidden',!c)}
function draw(points){const svg=document.getElementById('chart');const W=1000,H=220,P=28,w=W-P*2,h=H-P*2;const vals=points.map(p=>Number(p.value||0));const max=Math.max(...vals,1);const poly=points.map((p,i)=>{const x=P+w*i/Math.max(points.length-1,1);const y=P+h-(h*(Number(p.value||0)/max));return `${x},${y}`}).join(' ');const area=points.map((p,i)=>{const x=P+w*i/Math.max(points.length-1,1);const y=P+h-(h*(Number(p.value||0)/max));return `${x},${y}`}).join(' ');svg.innerHTML=`<line x1="${P}" y1="${P}" x2="${P}" y2="${H-P}" stroke="#d1d5db"/><line x1="${P}" y1="${H-P}" x2="${W-P}" y2="${H-P}" stroke="#d1d5db"/><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#dc2626" stop-opacity=".28"/><stop offset="100%" stop-color="#dc2626" stop-opacity=".02"/></linearGradient></defs><polygon points="${P},${H-P} ${area} ${W-P},${H-P}" fill="url(#g)"></polygon><polyline points="${poly}" fill="none" stroke="#dc2626" stroke-width="3"/>`;c_start.textContent=points[0]?points[0].date:'-';c_end.textContent=points.length?points[points.length-1].date:'-';c_max.textContent=`max: ${max.toFixed(2)}`}

async function loadReport(){try{const m=r_metric.value,p=r_period.value,f=r_from.value,t=r_to.value;const q=new URLSearchParams({metric:m,period:p,from:f,to:t});const d=await api(`${API}/stats.php?action=report-timeseries&${q.toString()}`);draw(d.points||[]);const b=await api(`${API}/stats.php?action=payment-breakdown&period=${encodeURIComponent(p)}&from=${encodeURIComponent(f)}&to=${encodeURIComponent(t)}`);tb_breakdown.innerHTML=(b.breakdown||[]).map(x=>`<tr><td>${x.metodo_pagamento}</td><td>${Number(x.totale_pagamenti||0)}</td><td>${eur(x.totale_importo||0)}</td></tr>`).join('')||'<tr><td colspan="3">Nessun dato</td></tr>';}catch(e){alertBox(e.message,'error')}}

async function exportUsers(){try{const r=await fetch(`${API}/stats.php?action=export-users`,{headers:{Authorization:`Bearer ${TOKEN}`}});if(!r.ok)throw new Error('Errore export');const blob=await r.blob();const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download=`utenti_${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}catch(e){alertBox(e.message,'error')}}

function logout(){localStorage.clear();location.href='../login.html';}

async function init(){try{await loadStats();await loadUsers();await loadPurchases();await loadDocs();await loadReport();}catch(e){alertBox(e.message,'error')}}
init();
</script>
</body>
</html>
