<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Bagnino</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#f3f4f6;color:#111827}
.header{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:28px}.container{max-width:1200px;margin:20px auto;padding:0 14px}
.btn{border:none;border-radius:8px;padding:8px 11px;font-weight:600;cursor:pointer;color:#fff;font-size:12px}.btn-danger{background:#dc2626}.btn-success{background:#059669}.btn-primary{background:#2563eb}.btn-muted{background:#6b7280}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:14px}.stat{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-radius:10px;padding:12px;text-align:center}.stat b{font-size:26px}
.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:14px}
.video-box{background:#111827;border-radius:10px;overflow:hidden;max-width:560px;margin:0 auto}.video-box video{width:100%;height:auto;display:block}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}.tools input{padding:9px;border:1px solid #d1d5db;border-radius:8px;flex:1;min-width:220px}
.alert{padding:10px 12px;border-radius:8px;margin-bottom:10px;font-weight:600}.alert.success{background:#d1fae5;color:#065f46}.alert.error{background:#fee2e2;color:#991b1b}.alert.info{background:#e0f2fe;color:#075985}
.table-wrap{overflow:auto}.t{width:100%;border-collapse:collapse}.t th{background:#f9fafb;font-size:12px;text-align:left;padding:8px;border-bottom:1px solid #e5e7eb}.t td{padding:8px;border-bottom:1px solid #f0f0f0;font-size:13px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}.ok{background:#d1fae5;color:#065f46}.warn{background:#fef3c7;color:#92400e}.err{background:#fee2e2;color:#991b1b}
</style>
</head>
<body>
<div class="header"><div><h1>Dashboard Bagnino</h1><small id="uname"></small></div><button class="btn btn-danger" onclick="logout()">Esci</button></div>
<div class="container">
<div id="alerts"></div>
<div class="stats"><div class="stat"><b id="s_total">0</b><div>Check-in Oggi</div></div><div class="stat"><b id="s_m">0</b><div>Mattina</div></div><div class="stat"><b id="s_p">0</b><div>Pomeriggio</div></div></div>
<div class="card">
<h3 style="margin-bottom:10px">Scansiona QR</h3>
<div class="video-box"><video id="cam" autoplay muted playsinline></video></div>
<div class="tools"><button class="btn btn-primary" onclick="startCamera()">Avvia camera</button><button class="btn btn-muted" onclick="stopCamera()">Ferma camera</button></div>
<div class="tools"><input id="qrInput" placeholder="Inserisci o scansiona codice QR"><button class="btn btn-success" onclick="verifyQR()">Verifica</button></div>
<div id="scanInfo"></div>
</div>
<div class="card">
<h3 style="margin-bottom:10px">Check-in di oggi</h3>
<div class="table-wrap"><table class="t"><thead><tr><th>Ora</th><th>Utente</th><th>Telefono</th><th>Pacchetto</th><th>Fascia</th></tr></thead><tbody id="tb_today"></tbody></table></div>
</div>
</div>
<script>
const API='../api';const TOKEN=localStorage.getItem('token');const USER=JSON.parse(localStorage.getItem('user')||'{}');if(!TOKEN||USER.ruolo!=='bagnino')location.href='../login.html';
uname.textContent=`${USER.nome||''} ${USER.cognome||''}`.trim();
let stream=null,scanTimer=null,lastCode='',currentData=null,isSubmitting=false;
function alertBox(m,t='info'){alerts.innerHTML=`<div class="alert ${t}">${m}</div>`;if(t!=='error')setTimeout(()=>alerts.innerHTML='',3200)}
async function api(url,opt={}){const r=await fetch(url,{...opt,headers:{Authorization:`Bearer ${TOKEN}`,...(opt.headers||{})}});const tx=await r.text();let d={};try{d=JSON.parse(tx);}catch(e){throw new Error('Risposta API non valida')}if(!r.ok||d.success===false)throw new Error(d.message||`Errore ${r.status}`);return d}

async function startCamera(){try{if(stream)stopCamera();stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});cam.srcObject=stream;alertBox('Camera attiva','success');startScanLoop();}catch(e){alertBox('Impossibile avviare camera. Usa inserimento manuale.','error')}}
function stopCamera(){if(scanTimer){clearInterval(scanTimer);scanTimer=null;}if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}cam.srcObject=null;}
function startScanLoop(){if(scanTimer)clearInterval(scanTimer);if(typeof BarcodeDetector==='undefined'){alertBox('BarcodeDetector non disponibile su questo browser. Usa input manuale.','info');return;}const detector=new BarcodeDetector({formats:['qr_code']});scanTimer=setInterval(async()=>{if(!stream||cam.readyState<2)return;try{const codes=await detector.detect(cam);if(codes&&codes.length){const raw=(codes[0].rawValue||'').trim();if(raw&&raw!==lastCode){lastCode=raw;qrInput.value=raw;verifyQR();}}}catch(err){}},900)}
async function verifyQR(){const qr=qrInput.value.trim();if(!qr){alertBox('Inserisci un codice QR','error');return;}try{const d=await api(`${API}/checkin.php?qr=${encodeURIComponent(qr)}`);currentData=d;const u=d.utente||{};const a=d.acquisto||{};const st=d.valid?'<span class="badge ok">valido</span>':'<span class="badge err">non valido</span>';const action=d.can_checkin?`<button class="btn btn-success" onclick="confirmCheckin()" ${isSubmitting?'disabled':''}>Conferma check-in</button>`:'<span class="badge warn">Solo lettura</span>';scanInfo.innerHTML=`<div class="alert ${d.valid?'success':'error'}">${d.message}</div><div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fafafa"><p><strong>Utente:</strong> ${u.nome||'-'} ${u.cognome||''}</p><p><strong>Telefono:</strong> ${u.telefono||'-'}</p><p><strong>Pacchetto:</strong> ${a.pacchetto_nome||'-'}</p><p><strong>Ingressi rimasti:</strong> ${a.ingressi_rimanenti ?? '-'}</p><p><strong>Scadenza:</strong> ${a.data_scadenza||'-'}</p><p><strong>Stato:</strong> ${st}</p><div class="tools" style="margin-top:8px">${action}<button class="btn btn-muted" onclick="clearScan()">Pulisci</button></div></div>`;}catch(e){alertBox(e.message,'error')}}

async function confirmCheckin(){if(!currentData||!currentData.can_checkin||isSubmitting)return;isSubmitting=true;try{const qr=qrInput.value.trim();const d=await api(`${API}/checkin.php`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({qr_code:qr})});alertBox(`Check-in registrato. Ingressi rimasti: ${d.ingressi_rimanenti}`,'success');clearScan();await loadToday();}catch(e){alertBox(e.message,'error')}finally{isSubmitting=false;}}
function clearScan(){qrInput.value='';scanInfo.innerHTML='';currentData=null;}

async function loadToday(){try{const d=await api(`${API}/checkin.php?action=today`);s_total.textContent=d.stats.totale;s_m.textContent=d.stats.mattina;s_p.textContent=d.stats.pomeriggio;tb_today.innerHTML=(d.checkins||[]).map(c=>`<tr><td>${new Date(c.timestamp).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}</td><td>${c.user_nome} ${c.user_cognome}</td><td>${c.user_telefono||'-'}</td><td>${c.pacchetto_nome}</td><td>${c.fascia_oraria}</td></tr>`).join('')||'<tr><td colspan="5">Nessun check-in oggi</td></tr>';}catch(e){alertBox(e.message,'error')}}

function logout(){stopCamera();localStorage.clear();location.href='../login.html';}
window.addEventListener('beforeunload',stopCamera);
loadToday();
</script>
</body>
</html>
