<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Segreteria - Gli Squaletti</title>
    <link rel="icon" type="image/png" href="https://www.genspark.ai/api/files/s/s3WpPfgP">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <div class="dashboard-logo">
                    <img src="https://www.genspark.ai/api/files/s/s3WpPfgP" alt="Gli Squaletti">
                    <span>Dashboard Segreteria</span>
                </div>
                <div class="dashboard-user">
                    <div class="dashboard-user-info">
                        <strong id="staffName">Segreteria</strong>
                        <small id="staffEmail">segreteria@glisqualetti.it</small>
                    </div>
                    <button class="btn-logout" onclick="Auth.logout()">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="dashboard-content">
        <div class="container">
            <h2><i class="fas fa-clipboard-check"></i> Pannello Segreteria</h2>

            <!-- Stats Cards -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-users"></i> Utenti Attivi</h3>
                    <div class="dashboard-stat" id="activeUsers">0</div>
                    <p>con ingressi disponibili</p>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-check"></i> Ingressi Oggi</h3>
                    <div class="dashboard-stat" id="todayEntries">0</div>
                    <p>registrati</p>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fas fa-euro-sign"></i> Incasso Giornata</h3>
                    <div class="dashboard-stat" style="font-size: 2rem;" id="todayCash">€0</div>
                    <p>contanti</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="admin-panel">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="showTab('check')">
                        <i class="fas fa-qrcode"></i> Verifica Ingresso
                    </button>
                    <button class="admin-tab" onclick="showTab('users')">
                        <i class="fas fa-users"></i> Gestione Utenti
                    </button>
                    <button class="admin-tab" onclick="showTab('report')">
                        <i class="fas fa-file-alt"></i> Report Giornaliero
                    </button>
                    <button class="admin-tab" onclick="window.location.href='qr-generator.html'">
                        <i class="fas fa-print"></i> Genera QR Codes
                    </button>
                </div>

                <!-- Tab Verifica Ingresso -->
                <div id="tabCheck" class="tab-content">
                    <h3>Scansiona QR Code</h3>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">
                        Scansiona il QR code dell'utente per registrare l'ingresso
                    </p>

                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 3rem; border-radius: 16px; text-align: center; margin-bottom: 2rem;">
                        <i class="fas fa-qrcode" style="font-size: 5rem; color: #0077b6; margin-bottom: 1rem;"></i>
                        <h4 style="color: #0077b6; margin-bottom: 1rem;">Scansione Rapida</h4>
                        <p style="color: #495057;">Usa la fotocamera del telefono per scansionare il QR code dell'utente</p>
                    </div>

                    <div class="form-group">
                        <label>Oppure inserisci manualmente il codice QR:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="manualQR" placeholder="es. USR001" style="flex: 1;">
                            <button class="btn btn-primary" onclick="verifyManualQR()">
                                <i class="fas fa-search"></i> Verifica
                            </button>
                        </div>
                    </div>

                    <div class="qr-test-codes" style="margin-top: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                        <h4 style="margin-bottom: 1rem;"><i class="fas fa-vial"></i> Codici Test</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button class="btn btn-secondary btn-sm" onclick="testQR('USR001')">
                                <i class="fas fa-user"></i> Mario Rossi (USR001)
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testQR('USR002')">
                                <i class="fas fa-user"></i> Laura Bianchi (USR002)
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testQR('USR003')">
                                <i class="fas fa-user"></i> Giuseppe Verdi (USR003)
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testQR('USR004')">
                                <i class="fas fa-user"></i> Anna Ferrari (USR004)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Gestione Utenti -->
                <div id="tabUsers" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Elenco Utenti</h3>
                        <div>
                            <input type="text" id="searchUsers" placeholder="Cerca utente..." style="margin-right: 0.5rem;">
                            <button class="btn btn-secondary" onclick="filterUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefono</th>
                                    <th>Pacchetto</th>
                                    <th>Ingressi</th>
                                    <th>Scadenza</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Popolato da JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Report Giornaliero -->
                <div id="tabReport" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h3>Report Giornaliero</h3>
                            <p style="color: var(--gray-600);">Riepilogo attività del <strong id="reportDate"></strong></p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="printReport()">
                                <i class="fas fa-print"></i> Stampa Report
                            </button>
                            <button class="btn btn-secondary" onclick="clearDay()">
                                <i class="fas fa-broom"></i> Chiudi Giornata
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-grid" style="margin-bottom: 2rem;">
                        <div class="dashboard-card">
                            <h4><i class="fas fa-sign-in-alt"></i> Ingressi Registrati</h4>
                            <div class="dashboard-stat" id="reportTotalEntries">0</div>
                        </div>
                        <div class="dashboard-card">
                            <h4><i class="fas fa-euro-sign"></i> Incasso Contanti</h4>
                            <div class="dashboard-stat" style="font-size: 2rem;" id="reportTotalCash">€0</div>
                        </div>
                        <div class="dashboard-card">
                            <h4><i class="fas fa-credit-card"></i> Pagamenti Registrati</h4>
                            <div class="dashboard-stat" id="reportTotalPayments">0</div>
                        </div>
                    </div>

                    <div id="reportContent">
                        <h4>Dettaglio Ingressi</h4>
                        <div id="entriesLog" style="max-height: 400px; overflow-y: auto;">
                            <!-- Popolato da JS -->
                        </div>

                        <h4 style="margin-top: 2rem;">Utenti in Scadenza (prossimi 30 giorni)</h4>
                        <div id="expiringUsers">
                            <!-- Popolato da JS -->
                        </div>

                        <h4 style="margin-top: 2rem;">Utenti con Pochi Ingressi (&le; 2)</h4>
                        <div id="lowEntriesUsers">
                            <!-- Popolato da JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // Verifica autenticazione
        const session = Auth.requireAuth(['segreteria']);
        if (!session) return;

        // Aggiorna header
        document.getElementById('staffName').textContent = session.name;
        document.getElementById('staffEmail').textContent = session.username + '@glisqualetti.it';

        // Tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
            event.target.closest('.admin-tab').classList.add('active');

            if (tabName === 'users') loadUsers();
            if (tabName === 'report') loadReport();
        }

        // Carica statistiche
        function loadStats() {
            const stats = Auth.getStats();
            document.getElementById('activeUsers').textContent = stats.activeUsers;
            document.getElementById('todayEntries').textContent = stats.todayEntries;
            document.getElementById('todayCash').textContent = '€' + stats.todayCash.toFixed(2);
        }

        // Test QR
        function testQR(qrCode) {
            window.location.href = `qr-verify.html?qr=${qrCode}`;
        }

        function verifyManualQR() {
            const qr = document.getElementById('manualQR').value.trim();
            if (qr) {
                window.location.href = `qr-verify.html?qr=${qr}`;
            } else {
                alert('Inserisci un codice QR valido');
            }
        }

        // Carica utenti
        function loadUsers() {
            const users = Auth.getAllUsers();
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const expiry = new Date(user.expiryDate);
                const today = new Date();
                const daysToExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                
                let statusBadge = '';
                if (user.remainingEntries === 0) {
                    statusBadge = '<span class="badge badge-danger">Esaurito</span>';
                } else if (daysToExpiry < 0) {
                    statusBadge = '<span class="badge badge-danger">Scaduto</span>';
                } else if (daysToExpiry <= 30) {
                    statusBadge = '<span class="badge badge-warning">Scade tra ' + daysToExpiry + ' giorni</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">Attivo</span>';
                }

                const row = `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.packageType === '10_entries' ? '10 Ingressi' : user.packageType === 'promo' ? 'Promo' : 'Singolo'}</td>
                        <td><strong>${user.remainingEntries}/${user.totalEntries}</strong></td>
                        <td>${user.expiryDate}<br>${statusBadge}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewUser('${user.id}')">
                                <i class="fas fa-eye"></i> Vedi
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="addPayment('${user.id}')">
                                <i class="fas fa-euro-sign"></i> Pagamento
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function viewUser(userId) {
            window.location.href = `user-detail.html?id=${userId}`;
        }

        function addPayment(userId) {
            const user = Auth.getUserById(userId);
            const packageType = prompt('Pacchetto:\n1 = Singolo (12€)\n2 = 10 Ingressi (100€)\n3 = Promo (30€)\n\nInserisci il numero:');
            
            let type, amount;
            switch(packageType) {
                case '1':
                    type = 'single';
                    amount = 12;
                    break;
                case '2':
                    type = '10_entries';
                    amount = 100;
                    break;
                case '3':
                    type = 'promo';
                    amount = 30;
                    break;
                default:
                    alert('Selezione non valida');
                    return;
            }

            const result = Auth.addCashPayment(userId, amount, type, session.name);
            if (result.success) {
                alert('Pagamento registrato con successo!');
                loadUsers();
                loadStats();
            } else {
                alert('Errore: ' + result.message);
            }
        }

        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Report
        function loadReport() {
            const report = Auth.getDailyReport();
            
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('it-IT');
            document.getElementById('reportTotalEntries').textContent = report.totalEntries;
            document.getElementById('reportTotalCash').textContent = '€' + report.totalCash.toFixed(2);
            document.getElementById('reportTotalPayments').textContent = report.payments.length;

            // Log ingressi
            const entriesLog = document.getElementById('entriesLog');
            entriesLog.innerHTML = '';
            
            if (report.entries.length === 0) {
                entriesLog.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 2rem;">Nessun ingresso registrato oggi</p>';
            } else {
                report.entries.forEach(entry => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 1rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;';
                    div.innerHTML = `
                        <div>
                            <strong>${entry.userName}</strong><br>
                            <small style="color: var(--gray-600);">Ore ${entry.time} - Registrato da ${entry.staffName}</small>
                        </div>
                        <div>
                            <span class="badge badge-success">Ingressi rimasti: ${entry.remainingAfter}</span>
                        </div>
                    `;
                    entriesLog.appendChild(div);
                });
            }

            // Utenti in scadenza
            const expiringDiv = document.getElementById('expiringUsers');
            const today = new Date();
            const in30Days = new Date(today.getTime() + 30*24*60*60*1000);
            const expiring = report.users.filter(u => {
                const exp = new Date(u.expiryDate);
                return exp > today && exp <= in30Days;
            });

            if (expiring.length === 0) {
                expiringDiv.innerHTML = '<p style="color: var(--gray-500);">Nessun utente in scadenza</p>';
            } else {
                expiringDiv.innerHTML = '<ul>' + expiring.map(u => 
                    `<li><strong>${u.name}</strong> - Scade il ${u.expiryDate} (${u.remainingEntries} ingressi rimasti)</li>`
                ).join('') + '</ul>';
            }

            // Utenti con pochi ingressi
            const lowDiv = document.getElementById('lowEntriesUsers');
            const lowEntries = report.users.filter(u => u.remainingEntries > 0 && u.remainingEntries <= 2);
            
            if (lowEntries.length === 0) {
                lowDiv.innerHTML = '<p style="color: var(--gray-500);">Nessun utente con pochi ingressi</p>';
            } else {
                lowDiv.innerHTML = '<ul>' + lowEntries.map(u => 
                    `<li><strong>${u.name}</strong> - ${u.remainingEntries} ingress${u.remainingEntries === 1 ? 'o' : 'i'} rimast${u.remainingEntries === 1 ? 'o' : 'i'}</li>`
                ).join('') + '</ul>';
            }
        }

        function printReport() {
            window.print();
        }

        function clearDay() {
            if (confirm('Confermi chiusura giornata? Tutti i dati saranno azzerati.')) {
                Auth.clearDailyReport();
                alert('Giornata chiusa! Report azzerato.');
                loadReport();
                loadStats();
            }
        }

        // Init
        loadStats();
    </script>
</body>
</html>
