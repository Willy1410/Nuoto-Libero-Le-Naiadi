<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Bagnino - Scanner QR</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>

  <header class="dashboard-header">
    <div class="header-left">
      <img src="/assets/logo.png" alt="Logo" class="logo-small">
      <h1>üèä Dashboard Bagnino</h1>
    </div>
    <div class="header-right">
      <span id="userName"></span>
      <button onclick="handleLogout()" class="btn btn-secondary">Esci</button>
    </div>
  </header>

  <nav class="dashboard-nav">
    <button class="nav-tab active" data-tab="scanner">üì∑ Scanner QR</button>
    <button class="nav-tab" data-tab="presenze">üìã Presenze Oggi</button>
    <button class="nav-tab" data-tab="storico">üìä Storico</button>
  </nav>

  <main class="dashboard-content">

    <!-- ===== TAB: SCANNER QR ===== -->
    <section id="tab-scanner" class="tab-pane active">
      <h2>üì∑ Scanner QR Code</h2>

      <div class="card scanner-container">
        <div id="reader" class="qr-reader"></div>
        
        <div class="scanner-controls">
          <button id="startScanBtn" class="btn btn-primary btn-large">
            üé• Avvia Scanner
          </button>
          <button id="stopScanBtn" class="btn btn-secondary btn-large" style="display: none;">
            ‚èπÔ∏è Ferma Scanner
          </button>
        </div>

        <!-- Risultato Scansione -->
        <div id="scanResult" class="scan-result" style="display: none;"></div>
      </div>

      <!-- Alert Info -->
      <div class="alert alert-info">
        <strong>‚ÑπÔ∏è Come funziona:</strong><br>
        1. Avvia lo scanner con il pulsante sopra<br>
        2. Inquadra il QR code dell'utente con la camera<br>
        3. Il sistema verificher√† automaticamente il QR e registrer√† l'ingresso<br>
        4. Vedrai il nome dell'utente e gli ingressi rimanenti
      </div>

      <!-- Test QR (solo development) -->
      <div class="card">
        <h3>üß™ Test QR Code (Development)</h3>
        <input type="text" id="testQRInput" placeholder="Inserisci codice QR manualmente">
        <button onclick="verificaQRManuale()" class="btn btn-secondary">Verifica</button>
      </div>
    </section>

    <!-- ===== TAB: PRESENZE OGGI ===== -->
    <section id="tab-presenze" class="tab-pane">
      <h2>üìã Presenze di Oggi</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üèä</div>
          <div class="stat-info">
            <h3 id="totalePresenzeOggi">0</h3>
            <p>Ingressi Oggi</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚òÄÔ∏è</div>
          <div class="stat-info">
            <h3 id="presenzeMattina">0</h3>
            <p>Fascia Mattina</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üåÖ</div>
          <div class="stat-info">
            <h3 id="presenzePomeriggio">0</h3>
            <p>Fascia Pomeriggio</p>
          </div>
        </div>
      </div>

      <!-- Lista Presenze -->
      <div class="card">
        <h3>Lista Ingressi di Oggi</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Ora</th>
              <th>Nome</th>
              <th>Fascia</th>
              <th>Ingressi Rimasti</th>
            </tr>
          </thead>
          <tbody id="listaPresenzeOggi">
            <tr>
              <td colspan="4" class="text-center text-muted">Nessun ingresso registrato oggi</td>
            </tr>
          </tbody>
        </table>
      </div>

      <button onclick="loadPresenzeOggi()" class="btn btn-primary">üîÑ Aggiorna Lista</button>
    </section>

    <!-- ===== TAB: STORICO ===== -->
    <section id="tab-storico" class="tab-pane">
      <h2>üìä Storico Presenze</h2>

      <div class="filters">
        <input type="date" id="filterData" max="">
        <button onclick="loadStorico()" class="btn btn-secondary">Filtra</button>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Ora</th>
            <th>Nome Utente</th>
            <th>Fascia</th>
          </tr>
        </thead>
        <tbody id="storicoPresenze">
          <tr>
            <td colspan="4" class="text-center text-muted">Seleziona una data</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <div id="loadingSpinner" class="spinner-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Audio Feedback -->
  <audio id="audioSuccess" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYHGmm98OScTgwOUKzn7bllHAU2jdXvw3ElBSh+zPDckTsKFmG38OihUQ0JR6Hf8rd"></audio>
  <audio id="audioError" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYHGmm98OScTgwOUKzn7bllHAU2jdXvw3ElBSh+zPDckTsKFmG38OihUQ0JR6Hf8rb"></audio>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script type="module">
    import { supabase, getCurrentUser, requireAuth, logout, formatDate, formatDateTime, getFasciaOraria, checkDoppioCheckIn, logActivity, ROLES } from '/js/supabase-client.js'

    let currentUser = null
    let html5QrCode = null

    // ===== INIT =====
    window.addEventListener('DOMContentLoaded', async () => {
      currentUser = await requireAuth(ROLES.BAGNINO)
      if (!currentUser) return

      document.getElementById('userName').textContent = currentUser.profilo.nome + ' ' + currentUser.profilo.cognome
      
      // Imposta data max filter a oggi
      document.getElementById('filterData').max = new Date().toISOString().split('T')[0]
      document.getElementById('filterData').value = new Date().toISOString().split('T')[0]

      loadPresenzeOggi()
      initScanner()
    })

    // ===== INIT SCANNER =====
    function initScanner() {
      html5QrCode = new Html5Qrcode("reader")

      document.getElementById('startScanBtn').addEventListener('click', startScanner)
      document.getElementById('stopScanBtn').addEventListener('click', stopScanner)
    }

    async function startScanner() {
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          onScanSuccess,
          onScanError
        )

        document.getElementById('startScanBtn').style.display = 'none'
        document.getElementById('stopScanBtn').style.display = 'inline-block'
        document.getElementById('scanResult').style.display = 'none'

      } catch (err) {
        console.error('Errore avvio scanner:', err)
        alert('‚ùå Impossibile avviare la camera: ' + err)
      }
    }

    async function stopScanner() {
      try {
        await html5QrCode.stop()
        document.getElementById('startScanBtn').style.display = 'inline-block'
        document.getElementById('stopScanBtn').style.display = 'none'
      } catch (err) {
        console.error('Errore stop scanner:', err)
      }
    }

    // ===== SCAN SUCCESS =====
    async function onScanSuccess(qrCodeMessage) {
      console.log('QR scansionato:', qrCodeMessage)
      
      // Ferma scanner temporaneamente
      await stopScanner()

      // Verifica QR
      await verificaQR(qrCodeMessage)

      // Riavvia dopo 3 secondi
      setTimeout(() => {
        if (document.getElementById('stopScanBtn').style.display === 'none') {
          startScanner()
        }
      }, 3000)
    }

    function onScanError(errorMessage) {
      // Ignora errori di scansione continui
    }

    // ===== VERIFICA QR =====
    async function verificaQR(qrCode) {
      try {
        document.getElementById('loadingSpinner').style.display = 'flex'
        document.getElementById('scanResult').style.display = 'block'

        // 1. Trova acquisto da QR code
        const { data: acquisto, error: errorAcquisto } = await supabase
          .from('acquisti')
          .select(`
            *,
            user:profili!acquisti_user_id_fkey(id, nome, cognome),
            pacchetto:pacchetti(nome)
          `)
          .eq('qr_code', qrCode)
          .single()

        if (errorAcquisto) {
          showError('‚ùå QR Code non valido o non trovato')
          return
        }

        // 2. Verifica stato pagamento
        if (acquisto.stato_pagamento !== 'confermato') {
          showError('‚ö†Ô∏è Pagamento non confermato')
          return
        }

        // 3. Verifica ingressi rimanenti
        if (acquisto.ingressi_rimanenti <= 0) {
          showError(`‚ùå ${acquisto.user.nome} ${acquisto.user.cognome}<br>Ingressi esauriti`)
          return
        }

        // 4. Verifica scadenza
        if (new Date(acquisto.data_scadenza) < new Date()) {
          showError(`‚ùå ${acquisto.user.nome} ${acquisto.user.cognome}<br>Pacchetto scaduto`)
          return
        }

        // 5. Verifica doppio check-in (4 ore, stessa fascia)
        const doppioCheckIn = await checkDoppioCheckIn(acquisto.user_id)
        if (doppioCheckIn.haCheckIn) {
          const minutiFa = Math.round((new Date() - doppioCheckIn.ultimoCheckIn) / 60000)
          showError(`‚ö†Ô∏è ${acquisto.user.nome} ${acquisto.user.cognome}<br>Check-in gi√† effettuato ${minutiFa} minuti fa`)
          return
        }

        // 6. Registra check-in
        const fasciaCorrente = getFasciaOraria()
        
        const { error: errorCheckIn } = await supabase
          .from('check_ins')
          .insert({
            user_id: acquisto.user_id,
            acquisto_id: acquisto.id,
            bagnino_id: currentUser.id,
            fascia_oraria: fasciaCorrente,
            timestamp: new Date().toISOString()
          })

        if (errorCheckIn) throw errorCheckIn

        // 7. Scala ingresso
        const nuoviIngressi = acquisto.ingressi_rimanenti - 1
        const { error: errorUpdate } = await supabase
          .from('acquisti')
          .update({ ingressi_rimanenti: nuoviIngressi })
          .eq('id', acquisto.id)

        if (errorUpdate) throw errorUpdate

        // 8. Log activity
        await logActivity('check_in_registrato', 'check_ins', acquisto.id, {
          user: `${acquisto.user.nome} ${acquisto.user.cognome}`,
          fascia: fasciaCorrente
        })

        // 9. Mostra successo
        showSuccess(`
          ‚úÖ <strong>Check-in Registrato!</strong><br><br>
          üë§ ${acquisto.user.nome} ${acquisto.user.cognome}<br>
          üé´ ${acquisto.pacchetto.nome}<br>
          üìä Ingressi rimanenti: <strong>${nuoviIngressi}</strong>
        `)

        // 10. Aggiorna lista presenze
        loadPresenzeOggi()

      } catch (error) {
        console.error('Errore verifica QR:', error)
        showError('‚ùå Errore sistema: ' + error.message)
      } finally {
        document.getElementById('loadingSpinner').style.display = 'none'
      }
    }

    function showSuccess(message) {
      const resultDiv = document.getElementById('scanResult')
      resultDiv.className = 'scan-result success'
      resultDiv.innerHTML = message
      resultDiv.style.display = 'block'

      // Suono + vibrazione
      document.getElementById('audioSuccess').play().catch(() => {})
      if (navigator.vibrate) navigator.vibrate([200, 100, 200])
    }

    function showError(message) {
      const resultDiv = document.getElementById('scanResult')
      resultDiv.className = 'scan-result error'
      resultDiv.innerHTML = message
      resultDiv.style.display = 'block'

      // Suono + vibrazione
      document.getElementById('audioError').play().catch(() => {})
      if (navigator.vibrate) navigator.vibrate([500])
    }

    // ===== VERIFICA QR MANUALE (test) =====
    window.verificaQRManuale = async function() {
      const qrCode = document.getElementById('testQRInput').value.trim()
      if (!qrCode) {
        alert('Inserisci un codice QR')
        return
      }
      await verificaQR(qrCode)
    }

    // ===== PRESENZE OGGI =====
    window.loadPresenzeOggi = async function() {
      try {
        const oggi = new Date().toISOString().split('T')[0]

        // Stats
        const { data: checkInsOggi } = await supabase
          .from('check_ins')
          .select('fascia_oraria')
          .gte('timestamp', oggi + ' 00:00:00')
          .lte('timestamp', oggi + ' 23:59:59')

        const totale = checkInsOggi?.length || 0
        const mattina = checkInsOggi?.filter(c => c.fascia_oraria === 'mattina').length || 0
        const pomeriggio = checkInsOggi?.filter(c => c.fascia_oraria === 'pomeriggio').length || 0

        document.getElementById('totalePresenzeOggi').textContent = totale
        document.getElementById('presenzeMattina').textContent = mattina
        document.getElementById('presenzePomeriggio').textContent = pomeriggio

        // Lista dettagliata
        const { data: presenze } = await supabase
          .from('check_ins')
          .select(`
            *,
            user:profili!check_ins_user_id_fkey(nome, cognome),
            acquisto:acquisti!check_ins_acquisto_id_fkey(ingressi_rimanenti)
          `)
          .gte('timestamp', oggi + ' 00:00:00')
          .lte('timestamp', oggi + ' 23:59:59')
          .order('timestamp', { ascending: false })

        if (presenze && presenze.length > 0) {
          const html = presenze.map(p => `
            <tr>
              <td>${new Date(p.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}</td>
              <td>${p.user.nome} ${p.user.cognome}</td>
              <td><span class="badge">${p.fascia_oraria}</span></td>
              <td><strong>${p.acquisto.ingressi_rimanenti}</strong></td>
            </tr>
          `).join('')
          document.getElementById('listaPresenzeOggi').innerHTML = html
        } else {
          document.getElementById('listaPresenzeOggi').innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nessun ingresso oggi</td></tr>'
        }

      } catch (error) {
        console.error('Errore caricamento presenze:', error)
      }
    }

    // ===== STORICO =====
    window.loadStorico = async function() {
      try {
        const data = document.getElementById('filterData').value

        if (!data) {
          alert('Seleziona una data')
          return
        }

        const { data: presenze } = await supabase
          .from('check_ins')
          .select(`
            *,
            user:profili!check_ins_user_id_fkey(nome, cognome)
          `)
          .gte('timestamp', data + ' 00:00:00')
          .lte('timestamp', data + ' 23:59:59')
          .order('timestamp', { ascending: false })

        if (presenze && presenze.length > 0) {
          const html = presenze.map(p => `
            <tr>
              <td>${formatDate(p.timestamp)}</td>
              <td>${new Date(p.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}</td>
              <td>${p.user.nome} ${p.user.cognome}</td>
              <td><span class="badge">${p.fascia_oraria}</span></td>
            </tr>
          `).join('')
          document.getElementById('storicoPresenze').innerHTML = html
        } else {
          document.getElementById('storicoPresenze').innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nessun ingresso in questa data</td></tr>'
        }

      } catch (error) {
        console.error('Errore caricamento storico:', error)
      }
    }

    // ===== TABS =====
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'))
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'))
        tab.classList.add('active')
        document.getElementById(`tab-${targetTab}`).classList.add('active')

        // Ferma scanner se cambio tab
        if (html5QrCode && html5QrCode.isScanning) {
          stopScanner()
        }
      })
    })

    // ===== LOGOUT =====
    window.handleLogout = logout

  </script>

</body>
</html>
